<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Advanced Program and Policy Evaluation (HPOL8539)</title>
<link>https://graveja0.github.io/HPOL8539-F2022/blog/index.html</link>
<atom:link href="https://graveja0.github.io/HPOL8539-F2022/blog/index.xml" rel="self" type="application/rss+xml"/>
<description></description>
<generator>quarto-1.0.36</generator>
<lastBuildDate>Wed, 09 Nov 2022 11:57:11 GMT</lastBuildDate>
<item>
  <title>A Practical Guide to Extended Difference-in-Differences</title>
  <link>https://graveja0.github.io/HPOL8539-F2022/blog/posts/extended-difference-in-differences.html</link>
  <description><![CDATA[ 



<div class="cell">

</div>
<div class="cell">

</div>
<section id="data-setup" class="level1 page-columns page-full">
<h1>Data Setup</h1>
<div class="column-screen">
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://graveja0.github.io/HPOL8539-F2022/blog/posts/extended-difference-in-differences_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<section id="determine-if-there-is-a-never-treated-cohort" class="level3">
<h3 class="anchored" data-anchor-id="determine-if-there-is-a-never-treated-cohort">1. Determine if there is a never treated cohort</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">n_years <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">max</span>(df_<span class="sc" style="color: #5E5E5E;">$</span>year) <span class="sc" style="color: #5E5E5E;">-</span> <span class="fu" style="color: #4758AB;">min</span>(df_<span class="sc" style="color: #5E5E5E;">$</span>year) <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb1-2"></span>
<span id="cb1-3">never_treated <span class="ot" style="color: #003B4F;">&lt;-</span> </span>
<span id="cb1-4">  df_ <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb1-5">  <span class="fu" style="color: #4758AB;">ungroup</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb1-6">  <span class="fu" style="color: #4758AB;">filter</span>(w_it<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">0</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb1-7">  <span class="fu" style="color: #4758AB;">group_by</span>(unit) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb1-8">  <span class="fu" style="color: #4758AB;">count</span>(year) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb1-9">  <span class="fu" style="color: #4758AB;">summarise</span>(<span class="at" style="color: #657422;">n =</span> <span class="fu" style="color: #4758AB;">sum</span>(n)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb1-10">  <span class="fu" style="color: #4758AB;">ungroup</span>()  <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb1-11">  <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">never_treated =</span> <span class="fu" style="color: #4758AB;">as.integer</span>(n<span class="sc" style="color: #5E5E5E;">==</span>n_years)) </span>
<span id="cb1-12"></span>
<span id="cb1-13">any_never_treated <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">max</span>(never_treated<span class="sc" style="color: #5E5E5E;">$</span>never_treated)<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb1-14">any_never_treated</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
</section>
<section id="identify-treatment-cohorts-d" class="level3">
<h3 class="anchored" data-anchor-id="identify-treatment-cohorts-d">2. Identify treatment cohorts (d*)</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">d_star <span class="ot" style="color: #003B4F;">&lt;-</span> </span>
<span id="cb3-2">  df_ <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb3-3">  <span class="fu" style="color: #4758AB;">select</span>(unit,year,w_it) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb3-4">  <span class="fu" style="color: #4758AB;">unique</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb3-5">  <span class="fu" style="color: #4758AB;">filter</span>(w_it<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb3-6">  <span class="fu" style="color: #4758AB;">group_by</span>(unit) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb3-7">  <span class="fu" style="color: #4758AB;">filter</span>(year<span class="sc" style="color: #5E5E5E;">==</span><span class="fu" style="color: #4758AB;">min</span>(year)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb3-8">  <span class="fu" style="color: #4758AB;">select</span>(<span class="sc" style="color: #5E5E5E;">-</span>w_it) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb3-9">  <span class="fu" style="color: #4758AB;">rename</span>(<span class="at" style="color: #657422;">d =</span> year) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb3-10">  <span class="fu" style="color: #4758AB;">dummy_cols</span>(<span class="st" style="color: #20794D;">"d"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb3-11">  <span class="fu" style="color: #4758AB;">select</span>(unit,<span class="fu" style="color: #4758AB;">starts_with</span>(<span class="st" style="color: #20794D;">"d_"</span>))</span>
<span id="cb3-12"></span>
<span id="cb3-13">last_treatment_year <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">colnames</span>(d_star)[<span class="fu" style="color: #4758AB;">length</span>(<span class="fu" style="color: #4758AB;">colnames</span>(d_star))] <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">gsub</span>(<span class="st" style="color: #20794D;">"d_"</span>,<span class="st" style="color: #20794D;">""</span>,.) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">as.numeric</span>(<span class="fu" style="color: #4758AB;">paste0</span>(.))</span>
<span id="cb3-14"><span class="fu" style="color: #4758AB;">colnames</span>(d_star)[<span class="sc" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>]</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "d_1989" "d_1998"</code></pre>
</div>
</div>
</section>
<section id="identify-all-post-treatment-years" class="level3">
<h3 class="anchored" data-anchor-id="identify-all-post-treatment-years">3. Identify All Post-Treatment Years</h3>
<p>If all groups are eventually treated, drop observations that occur on or after the last treatment date. This group has no untreated comparison group. Moreover, after this group is treated, it should not be utilized as a comparison group for the earlier treated cohorts.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1">f_star <span class="ot" style="color: #003B4F;">&lt;-</span> </span>
<span id="cb5-2">   <span class="fu" style="color: #4758AB;">with</span>(df_,<span class="fu" style="color: #4758AB;">table</span>(year,w_it)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">data.frame</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb5-3">   <span class="fu" style="color: #4758AB;">filter</span>(w_it<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1</span> <span class="sc" style="color: #5E5E5E;">&amp;</span> Freq<span class="sc" style="color: #5E5E5E;">&gt;</span><span class="dv" style="color: #AD0000;">0</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb5-4">   <span class="fu" style="color: #4758AB;">select</span>(<span class="at" style="color: #657422;">f_star =</span> year)</span>
<span id="cb5-5"></span>
<span id="cb5-6"><span class="cf" style="color: #003B4F;">if</span> (<span class="sc" style="color: #5E5E5E;">!</span>any_never_treated) {</span>
<span id="cb5-7">  f_star <span class="ot" style="color: #003B4F;">&lt;-</span> </span>
<span id="cb5-8">    f_star <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb5-9">    <span class="fu" style="color: #4758AB;">filter</span>(<span class="fu" style="color: #4758AB;">as.numeric</span>(<span class="fu" style="color: #4758AB;">paste0</span>(f_star)) <span class="sc" style="color: #5E5E5E;">&lt;</span> last_treatment_year) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb5-10">    <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">f_star =</span> <span class="fu" style="color: #4758AB;">as.numeric</span>(<span class="fu" style="color: #4758AB;">paste0</span>(f_star))) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb5-11">    <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">f_star =</span> <span class="fu" style="color: #4758AB;">factor</span>(f_star))</span>
<span id="cb5-12">}</span></code></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">

<table class="table" style="margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;">  </th>
   <th style="text-align:left;">  </th>
   <th style="text-align:left;">  </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> f_star_1980 </td>
   <td style="text-align:left;"> f_star_1992 </td>
   <td style="text-align:left;"> f_star_2004 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_star_1981 </td>
   <td style="text-align:left;"> f_star_1993 </td>
   <td style="text-align:left;"> f_star_2005 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_star_1982 </td>
   <td style="text-align:left;"> f_star_1994 </td>
   <td style="text-align:left;"> f_star_2006 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_star_1983 </td>
   <td style="text-align:left;"> f_star_1995 </td>
   <td style="text-align:left;"> f_star_2007 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_star_1984 </td>
   <td style="text-align:left;"> f_star_1996 </td>
   <td style="text-align:left;"> f_star_2008 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_star_1985 </td>
   <td style="text-align:left;"> f_star_1997 </td>
   <td style="text-align:left;"> f_star_2009 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_star_1986 </td>
   <td style="text-align:left;"> f_star_1998 </td>
   <td style="text-align:left;"> f_star_2010 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_star_1987 </td>
   <td style="text-align:left;"> f_star_1999 </td>
   <td style="text-align:left;"> f_star_2011 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_star_1988 </td>
   <td style="text-align:left;"> f_star_2000 </td>
   <td style="text-align:left;"> f_star_2012 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_star_1989 </td>
   <td style="text-align:left;"> f_star_2001 </td>
   <td style="text-align:left;"> f_star_2013 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_star_1990 </td>
   <td style="text-align:left;"> f_star_2002 </td>
   <td style="text-align:left;"> f_star_2014 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_star_1991 </td>
   <td style="text-align:left;"> f_star_2003 </td>
   <td style="text-align:left;"> f_star_2015 </td>
  </tr>
</tbody>
</table>

</div>
</div>
</section>
<section id="define-all-cohort-post-treatment-interactions" class="level3">
<h3 class="anchored" data-anchor-id="define-all-cohort-post-treatment-interactions">4. Define all cohort * post-treatment interactions</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">cohort_year_interactions <span class="ot" style="color: #003B4F;">&lt;-</span> </span>
<span id="cb6-2">  <span class="fu" style="color: #4758AB;">crossing</span>(<span class="at" style="color: #657422;">d =</span> <span class="fu" style="color: #4758AB;">as.numeric</span>(<span class="fu" style="color: #4758AB;">gsub</span>(<span class="st" style="color: #20794D;">"d_"</span>,<span class="st" style="color: #20794D;">""</span>,<span class="fu" style="color: #4758AB;">grep</span>(<span class="st" style="color: #20794D;">"d_"</span>,<span class="fu" style="color: #4758AB;">colnames</span>(d_star),<span class="at" style="color: #657422;">value=</span><span class="cn" style="color: #8f5902;">TRUE</span>))),<span class="at" style="color: #657422;">f =</span> <span class="fu" style="color: #4758AB;">as.numeric</span>(<span class="fu" style="color: #4758AB;">paste0</span>(f_star<span class="sc" style="color: #5E5E5E;">$</span>f_star))) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-3">  <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">value =</span> <span class="fu" style="color: #4758AB;">as.numeric</span>(f<span class="sc" style="color: #5E5E5E;">&gt;=</span>d)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-4">  <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">f =</span> <span class="fu" style="color: #4758AB;">paste0</span>(<span class="st" style="color: #20794D;">"f_"</span>,f)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-5">  <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">d =</span> <span class="fu" style="color: #4758AB;">paste0</span>(<span class="st" style="color: #20794D;">"d_"</span>,d)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-6">  <span class="fu" style="color: #4758AB;">spread</span>(f,value) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-7">  <span class="fu" style="color: #4758AB;">gather</span>(f,value,<span class="sc" style="color: #5E5E5E;">-</span>d) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-8">  <span class="fu" style="color: #4758AB;">filter</span>(value<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-9">  <span class="fu" style="color: #4758AB;">arrange</span>(d,f) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-10">  <span class="fu" style="color: #4758AB;">select</span>(<span class="sc" style="color: #5E5E5E;">-</span>value) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-11">  <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">i =</span> <span class="fu" style="color: #4758AB;">paste0</span>(<span class="st" style="color: #20794D;">"I("</span>,d,<span class="st" style="color: #20794D;">"*"</span>,f,<span class="st" style="color: #20794D;">")"</span>))</span>
<span id="cb6-12"></span>
<span id="cb6-13"><span class="cf" style="color: #003B4F;">if</span> (any_never_treated) {</span>
<span id="cb6-14">  df_ <span class="ot" style="color: #003B4F;">&lt;-</span> </span>
<span id="cb6-15">    df_ <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-16">    <span class="fu" style="color: #4758AB;">select</span>(unit,year,y_it,<span class="fu" style="color: #4758AB;">starts_with</span>(<span class="st" style="color: #20794D;">"x_i"</span>),w_it) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-17">    <span class="fu" style="color: #4758AB;">left_join</span>(d_star,<span class="st" style="color: #20794D;">"unit"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-18">    <span class="fu" style="color: #4758AB;">mutate_at</span>(<span class="fu" style="color: #4758AB;">vars</span>(<span class="fu" style="color: #4758AB;">starts_with</span>(<span class="st" style="color: #20794D;">"d_"</span>)),<span class="sc" style="color: #5E5E5E;">~</span><span class="fu" style="color: #4758AB;">ifelse</span>(<span class="fu" style="color: #4758AB;">is.na</span>(.),<span class="dv" style="color: #AD0000;">0</span>,.)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-19">    <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">f =</span> <span class="fu" style="color: #4758AB;">ifelse</span>(year <span class="sc" style="color: #5E5E5E;">%in%</span> f_star<span class="sc" style="color: #5E5E5E;">$</span>f_star,year,<span class="cn" style="color: #8f5902;">NA</span>)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-20">    <span class="fu" style="color: #4758AB;">dummy_cols</span>(<span class="st" style="color: #20794D;">"f"</span>,<span class="at" style="color: #657422;">ignore_na=</span><span class="cn" style="color: #8f5902;">TRUE</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-21">    <span class="fu" style="color: #4758AB;">mutate_at</span>(<span class="fu" style="color: #4758AB;">vars</span>(<span class="fu" style="color: #4758AB;">starts_with</span>(<span class="st" style="color: #20794D;">"f_"</span>)),<span class="sc" style="color: #5E5E5E;">~</span><span class="fu" style="color: #4758AB;">ifelse</span>(<span class="fu" style="color: #4758AB;">is.na</span>(.),<span class="dv" style="color: #AD0000;">0</span>,.))  <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-22">    <span class="fu" style="color: #4758AB;">dummy_cols</span>(<span class="st" style="color: #20794D;">"year"</span>,<span class="at" style="color: #657422;">ignore_na=</span><span class="cn" style="color: #8f5902;">TRUE</span>)</span>
<span id="cb6-23">} <span class="cf" style="color: #003B4F;">else</span> {</span>
<span id="cb6-24">   df_ <span class="ot" style="color: #003B4F;">&lt;-</span> </span>
<span id="cb6-25">    df_ <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-26">    <span class="fu" style="color: #4758AB;">filter</span>(year <span class="sc" style="color: #5E5E5E;">&lt;</span> last_treatment_year) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-27">    <span class="fu" style="color: #4758AB;">select</span>(unit,year,y_it,<span class="fu" style="color: #4758AB;">starts_with</span>(<span class="st" style="color: #20794D;">"x_i"</span>),w_it) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-28">    <span class="fu" style="color: #4758AB;">left_join</span>(d_star,<span class="st" style="color: #20794D;">"unit"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-29">    <span class="fu" style="color: #4758AB;">mutate_at</span>(<span class="fu" style="color: #4758AB;">vars</span>(<span class="fu" style="color: #4758AB;">starts_with</span>(<span class="st" style="color: #20794D;">"d_"</span>)),<span class="sc" style="color: #5E5E5E;">~</span><span class="fu" style="color: #4758AB;">ifelse</span>(<span class="fu" style="color: #4758AB;">is.na</span>(.),<span class="dv" style="color: #AD0000;">0</span>,.)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-30">    <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">f =</span> <span class="fu" style="color: #4758AB;">ifelse</span>(year <span class="sc" style="color: #5E5E5E;">%in%</span> f_star<span class="sc" style="color: #5E5E5E;">$</span>f_star,year,<span class="cn" style="color: #8f5902;">NA</span>)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-31">    <span class="fu" style="color: #4758AB;">dummy_cols</span>(<span class="st" style="color: #20794D;">"f"</span>,<span class="at" style="color: #657422;">ignore_na=</span><span class="cn" style="color: #8f5902;">TRUE</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-32">    <span class="fu" style="color: #4758AB;">mutate_at</span>(<span class="fu" style="color: #4758AB;">vars</span>(<span class="fu" style="color: #4758AB;">starts_with</span>(<span class="st" style="color: #20794D;">"f_"</span>)),<span class="sc" style="color: #5E5E5E;">~</span><span class="fu" style="color: #4758AB;">ifelse</span>(<span class="fu" style="color: #4758AB;">is.na</span>(.),<span class="dv" style="color: #AD0000;">0</span>,.))  <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-33">    <span class="fu" style="color: #4758AB;">dummy_cols</span>(<span class="st" style="color: #20794D;">"year"</span>,<span class="at" style="color: #657422;">ignore_na=</span><span class="cn" style="color: #8f5902;">TRUE</span>)</span>
<span id="cb6-34">}</span></code></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">

<table class="table" style="margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:left;"> f </th>
   <th style="text-align:left;"> d_1989 </th>
   <th style="text-align:left;"> d_1998 </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> f_1989 </td>
   <td style="text-align:left;"> Y </td>
   <td style="text-align:left;"> - </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_1990 </td>
   <td style="text-align:left;"> Y </td>
   <td style="text-align:left;"> - </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_1991 </td>
   <td style="text-align:left;"> Y </td>
   <td style="text-align:left;"> - </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_1992 </td>
   <td style="text-align:left;"> Y </td>
   <td style="text-align:left;"> - </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_1993 </td>
   <td style="text-align:left;"> Y </td>
   <td style="text-align:left;"> - </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_1994 </td>
   <td style="text-align:left;"> Y </td>
   <td style="text-align:left;"> - </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_1995 </td>
   <td style="text-align:left;"> Y </td>
   <td style="text-align:left;"> - </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_1996 </td>
   <td style="text-align:left;"> Y </td>
   <td style="text-align:left;"> - </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_1997 </td>
   <td style="text-align:left;"> Y </td>
   <td style="text-align:left;"> - </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_1998 </td>
   <td style="text-align:left;"> Y </td>
   <td style="text-align:left;"> Y </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_1999 </td>
   <td style="text-align:left;"> Y </td>
   <td style="text-align:left;"> Y </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_2000 </td>
   <td style="text-align:left;"> Y </td>
   <td style="text-align:left;"> Y </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_2001 </td>
   <td style="text-align:left;"> Y </td>
   <td style="text-align:left;"> Y </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_2002 </td>
   <td style="text-align:left;"> Y </td>
   <td style="text-align:left;"> Y </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_2003 </td>
   <td style="text-align:left;"> Y </td>
   <td style="text-align:left;"> Y </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_2004 </td>
   <td style="text-align:left;"> Y </td>
   <td style="text-align:left;"> Y </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_2005 </td>
   <td style="text-align:left;"> Y </td>
   <td style="text-align:left;"> Y </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_2006 </td>
   <td style="text-align:left;"> Y </td>
   <td style="text-align:left;"> Y </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_2007 </td>
   <td style="text-align:left;"> Y </td>
   <td style="text-align:left;"> Y </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_2008 </td>
   <td style="text-align:left;"> Y </td>
   <td style="text-align:left;"> Y </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_2009 </td>
   <td style="text-align:left;"> Y </td>
   <td style="text-align:left;"> Y </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_2010 </td>
   <td style="text-align:left;"> Y </td>
   <td style="text-align:left;"> Y </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_2011 </td>
   <td style="text-align:left;"> Y </td>
   <td style="text-align:left;"> Y </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_2012 </td>
   <td style="text-align:left;"> Y </td>
   <td style="text-align:left;"> Y </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_2013 </td>
   <td style="text-align:left;"> Y </td>
   <td style="text-align:left;"> Y </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_2014 </td>
   <td style="text-align:left;"> Y </td>
   <td style="text-align:left;"> Y </td>
  </tr>
  <tr>
   <td style="text-align:left;"> f_2015 </td>
   <td style="text-align:left;"> Y </td>
   <td style="text-align:left;"> Y </td>
  </tr>
</tbody>
</table>

</div>
</div>
</section>
</section>
<section id="estimation" class="level1">
<h1>Estimation</h1>
<section id="common-treatment-timing" class="level2">
<h2 class="anchored" data-anchor-id="common-treatment-timing">Common Treatment Timing</h2>
<table class="table">
<colgroup>
<col style="width: 26%">
<col style="width: 47%">
<col style="width: 26%">
</colgroup>
<thead>
<tr class="header">
<th>Method</th>
<th>Estimation Formula</th>
<th>Fixed or Random Effect</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Two-Way Fixed Effects</td>
<td><code>feols(I(w : f*) + factor(time)  | unit)</code></td>
<td>Unit Fixed Effect</td>
</tr>
<tr class="even">
<td>Pooled OLS</td>
<td><code>lm(I(w : f*) + factor(time) + d*)</code></td>
<td></td>
</tr>
<tr class="odd">
<td>Two-Way Mundlak</td>
<td><code>lmer(I(w : f*) + factor(time) + d* + (1|unit)</code></td>
<td>Unit Random Effect</td>
</tr>
</tbody>
</table>
</section>
<section id="staggered-treatment-timing" class="level2">
<h2 class="anchored" data-anchor-id="staggered-treatment-timing">Staggered Treatment Timing</h2>
<table class="table">
<colgroup>
<col style="width: 26%">
<col style="width: 47%">
<col style="width: 26%">
</colgroup>
<thead>
<tr class="header">
<th>Method</th>
<th>Estimation Formula</th>
<th>Fixed or Random Effect</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Two-Way Fixed Effects</td>
<td><code>feols(I(d* : f*) + factor(time)  | unit)</code></td>
<td>Unit Fixed Effect</td>
</tr>
<tr class="even">
<td>Pooled OLS</td>
<td><code>lm(I(d* : f*) + factor(time) + d*)</code></td>
<td></td>
</tr>
<tr class="odd">
<td>Two-Way Mundlak</td>
<td><code>lmer(I(d* : f*) + factor(time) + d* + (1|unit)</code></td>
<td>Unit Random Effect</td>
</tr>
</tbody>
</table>
</section>
<section id="staggered-treatment-timing-with-covariates" class="level2">
<h2 class="anchored" data-anchor-id="staggered-treatment-timing-with-covariates">Staggered Treatment Timing with Covariate(s)</h2>
<table class="table">
<colgroup>
<col style="width: 26%">
<col style="width: 47%">
<col style="width: 26%">
</colgroup>
<thead>
<tr class="header">
<th>Method</th>
<th>Estimation Formula</th>
<th>Fixed or Random Effect</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Two-Way Fixed Effects</td>
<td><code>feols(I(w : d* : f*) + I(w : d* : f* : x_dm_d*) + factor(time) + I(factor(time) * x_dm_d*) | unit)</code></td>
<td>Unit Fixed Effect</td>
</tr>
<tr class="even">
<td>Pooled OLS</td>
<td><code>lm(I(w : d* : f*) + I(w: d* : f* : x_dm_d*) + factor(time) + I(factor(time) : x_dm_d*) + d* + x + I(d* : x_dm_d*))</code></td>
<td></td>
</tr>
<tr class="odd">
<td>Two-Way Mundlak</td>
<td><code>lmer(I(w : d* : f*) + I(w: d* : f* : x_dm_d*) + factor(time) + I(factor(time) : x_dm_d*) + d* +  x + I(d* : x_dm_d*) + (1|unit)</code></td>
<td>Unit Random Effect</td>
</tr>
</tbody>
</table>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">ff_twfe <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">as.formula</span>(<span class="fu" style="color: #4758AB;">paste0</span>(<span class="st" style="color: #20794D;">"y_it ~"</span>,<span class="fu" style="color: #4758AB;">paste0</span>(cohort_year_interactions<span class="sc" style="color: #5E5E5E;">$</span>i,<span class="at" style="color: #657422;">collapse=</span><span class="st" style="color: #20794D;">"+"</span>),<span class="st" style="color: #20794D;">"+ factor(year) | unit"</span>))</span>
<span id="cb7-2">fit_twfe <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">feols</span>(ff_twfe, <span class="at" style="color: #657422;">data =</span> df_)</span>
<span id="cb7-3"></span>
<span id="cb7-4">ff_pols <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">as.formula</span>(<span class="fu" style="color: #4758AB;">paste0</span>(<span class="st" style="color: #20794D;">"y_it ~"</span>,<span class="fu" style="color: #4758AB;">paste0</span>(cohort_year_interactions<span class="sc" style="color: #5E5E5E;">$</span>i,<span class="at" style="color: #657422;">collapse=</span><span class="st" style="color: #20794D;">"+"</span>),<span class="st" style="color: #20794D;">"+"</span>,<span class="fu" style="color: #4758AB;">paste0</span>(<span class="fu" style="color: #4758AB;">grep</span>(<span class="st" style="color: #20794D;">"^d_"</span>,<span class="fu" style="color: #4758AB;">colnames</span>(df_), <span class="at" style="color: #657422;">value=</span><span class="cn" style="color: #8f5902;">TRUE</span>),<span class="at" style="color: #657422;">collapse=</span><span class="st" style="color: #20794D;">"+"</span>),<span class="st" style="color: #20794D;">"+ factor(year)"</span>))</span>
<span id="cb7-5">fit_pols <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">lm</span>(ff_pols,<span class="at" style="color: #657422;">data =</span> df_)</span>
<span id="cb7-6"></span>
<span id="cb7-7">ff_re <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">as.formula</span>(<span class="fu" style="color: #4758AB;">paste0</span>(<span class="st" style="color: #20794D;">"y_it ~"</span>,<span class="fu" style="color: #4758AB;">paste0</span>(cohort_year_interactions<span class="sc" style="color: #5E5E5E;">$</span>i,<span class="at" style="color: #657422;">collapse=</span><span class="st" style="color: #20794D;">"+"</span>),<span class="st" style="color: #20794D;">"+"</span>,<span class="fu" style="color: #4758AB;">paste0</span>(<span class="fu" style="color: #4758AB;">grep</span>(<span class="st" style="color: #20794D;">"^d_"</span>,<span class="fu" style="color: #4758AB;">colnames</span>(df_), <span class="at" style="color: #657422;">value=</span><span class="cn" style="color: #8f5902;">TRUE</span>),<span class="at" style="color: #657422;">collapse=</span><span class="st" style="color: #20794D;">"+"</span>),<span class="st" style="color: #20794D;">"+ factor(year) + (1| unit)"</span>))</span>
<span id="cb7-8">fit_re <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">lmer</span>(ff_re, <span class="at" style="color: #657422;">data =</span> df_)</span></code></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">

<div id="hlokydwpei" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#hlokydwpei .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#hlokydwpei .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#hlokydwpei .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#hlokydwpei .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#hlokydwpei .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#hlokydwpei .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#hlokydwpei .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#hlokydwpei .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#hlokydwpei .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#hlokydwpei .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#hlokydwpei .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#hlokydwpei .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#hlokydwpei .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#hlokydwpei .gt_from_md > :first-child {
  margin-top: 0;
}

#hlokydwpei .gt_from_md > :last-child {
  margin-bottom: 0;
}

#hlokydwpei .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#hlokydwpei .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#hlokydwpei .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#hlokydwpei .gt_row_group_first td {
  border-top-width: 2px;
}

#hlokydwpei .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#hlokydwpei .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#hlokydwpei .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#hlokydwpei .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#hlokydwpei .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#hlokydwpei .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#hlokydwpei .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#hlokydwpei .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#hlokydwpei .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#hlokydwpei .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-left: 4px;
  padding-right: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#hlokydwpei .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#hlokydwpei .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#hlokydwpei .gt_left {
  text-align: left;
}

#hlokydwpei .gt_center {
  text-align: center;
}

#hlokydwpei .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#hlokydwpei .gt_font_normal {
  font-weight: normal;
}

#hlokydwpei .gt_font_bold {
  font-weight: bold;
}

#hlokydwpei .gt_font_italic {
  font-style: italic;
}

#hlokydwpei .gt_super {
  font-size: 65%;
}

#hlokydwpei .gt_footnote_marks {
  font-style: italic;
  font-weight: normal;
  font-size: 75%;
  vertical-align: 0.4em;
}

#hlokydwpei .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#hlokydwpei .gt_indent_1 {
  text-indent: 5px;
}

#hlokydwpei .gt_indent_2 {
  text-indent: 10px;
}

#hlokydwpei .gt_indent_3 {
  text-indent: 15px;
}

#hlokydwpei .gt_indent_4 {
  text-indent: 20px;
}

#hlokydwpei .gt_indent_5 {
  text-indent: 25px;
}
</style>
<table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col">Estimator</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_left" rowspan="1" colspan="1" scope="col">Regression Call</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr><td class="gt_row gt_left">TWFE</td>
<td class="gt_row gt_left">feols(y_it ~ I(d_1989 * f_1989) + I(d_1989 * f_1990) + I(d_1989 * f_1991) +      I(d_1989 * f_1992) + I(d_1989 * f_1993) + I(d_1989 * f_1994) +      I(d_1989 * f_1995) + I(d_1989 * f_1996) + I(d_1989 * f_1997) +      I(d_1989 * f_1998) + I(d_1989 * f_1999) + I(d_1989 * f_2000) +      I(d_1989 * f_2001) + I(d_1989 * f_2002) + I(d_1989 * f_2003) +      I(d_1989 * f_2004) + I(d_1989 * f_2005) + I(d_1989 * f_2006) +      I(d_1989 * f_2007) + I(d_1989 * f_2008) + I(d_1989 * f_2009) +      I(d_1989 * f_2010) + I(d_1989 * f_2011) + I(d_1989 * f_2012) +      I(d_1989 * f_2013) + I(d_1989 * f_2014) + I(d_1989 * f_2015) +      I(d_1998 * f_1998) + I(d_1998 * f_1999) + I(d_1998 * f_2000) +      I(d_1998 * f_2001) + I(d_1998 * f_2002) + I(d_1998 * f_2003) +      I(d_1998 * f_2004) + I(d_1998 * f_2005) + I(d_1998 * f_2006) +      I(d_1998 * f_2007) + I(d_1998 * f_2008) + I(d_1998 * f_2009) +      I(d_1998 * f_2010) + I(d_1998 * f_2011) + I(d_1998 * f_2012) +      I(d_1998 * f_2013) + I(d_1998 * f_2014) + I(d_1998 * f_2015) +      factor(year) | unit, data = df_)</td></tr>
    <tr><td class="gt_row gt_left">POLS</td>
<td class="gt_row gt_left">lm(y_it ~ I(d_1989 * f_1989) + I(d_1989 * f_1990) + I(d_1989 * f_1991) +      I(d_1989 * f_1992) + I(d_1989 * f_1993) + I(d_1989 * f_1994) +      I(d_1989 * f_1995) + I(d_1989 * f_1996) + I(d_1989 * f_1997) +      I(d_1989 * f_1998) + I(d_1989 * f_1999) + I(d_1989 * f_2000) +      I(d_1989 * f_2001) + I(d_1989 * f_2002) + I(d_1989 * f_2003) +      I(d_1989 * f_2004) + I(d_1989 * f_2005) + I(d_1989 * f_2006) +      I(d_1989 * f_2007) + I(d_1989 * f_2008) + I(d_1989 * f_2009) +      I(d_1989 * f_2010) + I(d_1989 * f_2011) + I(d_1989 * f_2012) +      I(d_1989 * f_2013) + I(d_1989 * f_2014) + I(d_1989 * f_2015) +      I(d_1998 * f_1998) + I(d_1998 * f_1999) + I(d_1998 * f_2000) +      I(d_1998 * f_2001) + I(d_1998 * f_2002) + I(d_1998 * f_2003) +      I(d_1998 * f_2004) + I(d_1998 * f_2005) + I(d_1998 * f_2006) +      I(d_1998 * f_2007) + I(d_1998 * f_2008) + I(d_1998 * f_2009) +      I(d_1998 * f_2010) + I(d_1998 * f_2011) + I(d_1998 * f_2012) +      I(d_1998 * f_2013) + I(d_1998 * f_2014) + I(d_1998 * f_2015) +      d_1989 + d_1998 + factor(year), data = df_)</td></tr>
    <tr><td class="gt_row gt_left">TWM</td>
<td class="gt_row gt_left">lmer(y_it ~ I(d_1989 * f_1989) + I(d_1989 * f_1990) + I(d_1989 * f_1991) +      I(d_1989 * f_1992) + I(d_1989 * f_1993) + I(d_1989 * f_1994) +      I(d_1989 * f_1995) + I(d_1989 * f_1996) + I(d_1989 * f_1997) +      I(d_1989 * f_1998) + I(d_1989 * f_1999) + I(d_1989 * f_2000) +      I(d_1989 * f_2001) + I(d_1989 * f_2002) + I(d_1989 * f_2003) +      I(d_1989 * f_2004) + I(d_1989 * f_2005) + I(d_1989 * f_2006) +      I(d_1989 * f_2007) + I(d_1989 * f_2008) + I(d_1989 * f_2009) +      I(d_1989 * f_2010) + I(d_1989 * f_2011) + I(d_1989 * f_2012) +      I(d_1989 * f_2013) + I(d_1989 * f_2014) + I(d_1989 * f_2015) +      I(d_1998 * f_1998) + I(d_1998 * f_1999) + I(d_1998 * f_2000) +      I(d_1998 * f_2001) + I(d_1998 * f_2002) + I(d_1998 * f_2003) +      I(d_1998 * f_2004) + I(d_1998 * f_2005) + I(d_1998 * f_2006) +      I(d_1998 * f_2007) + I(d_1998 * f_2008) + I(d_1998 * f_2009) +      I(d_1998 * f_2010) + I(d_1998 * f_2011) + I(d_1998 * f_2012) +      I(d_1998 * f_2013) + I(d_1998 * f_2014) + I(d_1998 * f_2015) +      d_1989 + d_1998 + factor(year) + (1 | unit), data = df_)</td></tr>
  </tbody>
  
  
</table>
</div>
</div>
</div>
</section>
</section>
<section id="results" class="level1 page-columns page-full">
<h1>Results</h1>
<div class="cell">
<div class="cell-output-display">

<table class="table" style="margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:right;"> Treatment Cohort </th>
   <th style="text-align:right;"> Year </th>
   <th style="text-align:right;"> POLS </th>
   <th style="text-align:right;"> E-TWFE </th>
   <th style="text-align:right;"> E-TWM </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 1989 </td>
   <td style="text-align:right;"> 1989 </td>
   <td style="text-align:right;"> 0.448 </td>
   <td style="text-align:right;"> 0.448 </td>
   <td style="text-align:right;"> 0.448 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1989 </td>
   <td style="text-align:right;"> 1990 </td>
   <td style="text-align:right;"> 1.060 </td>
   <td style="text-align:right;"> 1.060 </td>
   <td style="text-align:right;"> 1.060 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1989 </td>
   <td style="text-align:right;"> 1991 </td>
   <td style="text-align:right;"> 1.501 </td>
   <td style="text-align:right;"> 1.501 </td>
   <td style="text-align:right;"> 1.501 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1989 </td>
   <td style="text-align:right;"> 1992 </td>
   <td style="text-align:right;"> 2.011 </td>
   <td style="text-align:right;"> 2.011 </td>
   <td style="text-align:right;"> 2.011 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1989 </td>
   <td style="text-align:right;"> 1993 </td>
   <td style="text-align:right;"> 2.448 </td>
   <td style="text-align:right;"> 2.448 </td>
   <td style="text-align:right;"> 2.448 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1989 </td>
   <td style="text-align:right;"> 1994 </td>
   <td style="text-align:right;"> 2.983 </td>
   <td style="text-align:right;"> 2.983 </td>
   <td style="text-align:right;"> 2.983 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1989 </td>
   <td style="text-align:right;"> 1995 </td>
   <td style="text-align:right;"> 3.460 </td>
   <td style="text-align:right;"> 3.460 </td>
   <td style="text-align:right;"> 3.460 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1989 </td>
   <td style="text-align:right;"> 1996 </td>
   <td style="text-align:right;"> 3.995 </td>
   <td style="text-align:right;"> 3.995 </td>
   <td style="text-align:right;"> 3.995 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1989 </td>
   <td style="text-align:right;"> 1997 </td>
   <td style="text-align:right;"> 4.520 </td>
   <td style="text-align:right;"> 4.520 </td>
   <td style="text-align:right;"> 4.520 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1989 </td>
   <td style="text-align:right;"> 1998 </td>
   <td style="text-align:right;"> 4.898 </td>
   <td style="text-align:right;"> 4.898 </td>
   <td style="text-align:right;"> 4.898 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1989 </td>
   <td style="text-align:right;"> 1999 </td>
   <td style="text-align:right;"> 5.496 </td>
   <td style="text-align:right;"> 5.496 </td>
   <td style="text-align:right;"> 5.496 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1989 </td>
   <td style="text-align:right;"> 2000 </td>
   <td style="text-align:right;"> 5.979 </td>
   <td style="text-align:right;"> 5.979 </td>
   <td style="text-align:right;"> 5.979 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1989 </td>
   <td style="text-align:right;"> 2001 </td>
   <td style="text-align:right;"> 6.589 </td>
   <td style="text-align:right;"> 6.589 </td>
   <td style="text-align:right;"> 6.589 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1989 </td>
   <td style="text-align:right;"> 2002 </td>
   <td style="text-align:right;"> 7.069 </td>
   <td style="text-align:right;"> 7.069 </td>
   <td style="text-align:right;"> 7.069 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1989 </td>
   <td style="text-align:right;"> 2003 </td>
   <td style="text-align:right;"> 7.509 </td>
   <td style="text-align:right;"> 7.509 </td>
   <td style="text-align:right;"> 7.509 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1989 </td>
   <td style="text-align:right;"> 2004 </td>
   <td style="text-align:right;"> 8.113 </td>
   <td style="text-align:right;"> 8.113 </td>
   <td style="text-align:right;"> 8.113 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1989 </td>
   <td style="text-align:right;"> 2005 </td>
   <td style="text-align:right;"> 8.455 </td>
   <td style="text-align:right;"> 8.455 </td>
   <td style="text-align:right;"> 8.455 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1989 </td>
   <td style="text-align:right;"> 2006 </td>
   <td style="text-align:right;"> 9.016 </td>
   <td style="text-align:right;"> 9.016 </td>
   <td style="text-align:right;"> 9.016 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1989 </td>
   <td style="text-align:right;"> 2007 </td>
   <td style="text-align:right;"> 9.503 </td>
   <td style="text-align:right;"> 9.503 </td>
   <td style="text-align:right;"> 9.503 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1989 </td>
   <td style="text-align:right;"> 2008 </td>
   <td style="text-align:right;"> 9.985 </td>
   <td style="text-align:right;"> 9.985 </td>
   <td style="text-align:right;"> 9.985 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1989 </td>
   <td style="text-align:right;"> 2009 </td>
   <td style="text-align:right;"> 10.554 </td>
   <td style="text-align:right;"> 10.554 </td>
   <td style="text-align:right;"> 10.554 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1989 </td>
   <td style="text-align:right;"> 2010 </td>
   <td style="text-align:right;"> 10.909 </td>
   <td style="text-align:right;"> 10.909 </td>
   <td style="text-align:right;"> 10.909 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1989 </td>
   <td style="text-align:right;"> 2011 </td>
   <td style="text-align:right;"> 11.587 </td>
   <td style="text-align:right;"> 11.587 </td>
   <td style="text-align:right;"> 11.587 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1989 </td>
   <td style="text-align:right;"> 2012 </td>
   <td style="text-align:right;"> 11.996 </td>
   <td style="text-align:right;"> 11.996 </td>
   <td style="text-align:right;"> 11.996 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1989 </td>
   <td style="text-align:right;"> 2013 </td>
   <td style="text-align:right;"> 12.545 </td>
   <td style="text-align:right;"> 12.545 </td>
   <td style="text-align:right;"> 12.545 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1989 </td>
   <td style="text-align:right;"> 2014 </td>
   <td style="text-align:right;"> 13.110 </td>
   <td style="text-align:right;"> 13.110 </td>
   <td style="text-align:right;"> 13.110 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1989 </td>
   <td style="text-align:right;"> 2015 </td>
   <td style="text-align:right;"> 13.500 </td>
   <td style="text-align:right;"> 13.500 </td>
   <td style="text-align:right;"> 13.500 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1998 </td>
   <td style="text-align:right;"> 1998 </td>
   <td style="text-align:right;"> 0.248 </td>
   <td style="text-align:right;"> 0.248 </td>
   <td style="text-align:right;"> 0.248 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1998 </td>
   <td style="text-align:right;"> 1999 </td>
   <td style="text-align:right;"> 0.507 </td>
   <td style="text-align:right;"> 0.507 </td>
   <td style="text-align:right;"> 0.507 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1998 </td>
   <td style="text-align:right;"> 2000 </td>
   <td style="text-align:right;"> 0.949 </td>
   <td style="text-align:right;"> 0.949 </td>
   <td style="text-align:right;"> 0.949 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1998 </td>
   <td style="text-align:right;"> 2001 </td>
   <td style="text-align:right;"> 1.288 </td>
   <td style="text-align:right;"> 1.288 </td>
   <td style="text-align:right;"> 1.288 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1998 </td>
   <td style="text-align:right;"> 2002 </td>
   <td style="text-align:right;"> 1.460 </td>
   <td style="text-align:right;"> 1.460 </td>
   <td style="text-align:right;"> 1.460 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1998 </td>
   <td style="text-align:right;"> 2003 </td>
   <td style="text-align:right;"> 1.775 </td>
   <td style="text-align:right;"> 1.775 </td>
   <td style="text-align:right;"> 1.775 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1998 </td>
   <td style="text-align:right;"> 2004 </td>
   <td style="text-align:right;"> 2.093 </td>
   <td style="text-align:right;"> 2.093 </td>
   <td style="text-align:right;"> 2.093 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1998 </td>
   <td style="text-align:right;"> 2005 </td>
   <td style="text-align:right;"> 2.321 </td>
   <td style="text-align:right;"> 2.321 </td>
   <td style="text-align:right;"> 2.321 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1998 </td>
   <td style="text-align:right;"> 2006 </td>
   <td style="text-align:right;"> 2.563 </td>
   <td style="text-align:right;"> 2.563 </td>
   <td style="text-align:right;"> 2.563 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1998 </td>
   <td style="text-align:right;"> 2007 </td>
   <td style="text-align:right;"> 2.879 </td>
   <td style="text-align:right;"> 2.879 </td>
   <td style="text-align:right;"> 2.879 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1998 </td>
   <td style="text-align:right;"> 2008 </td>
   <td style="text-align:right;"> 3.121 </td>
   <td style="text-align:right;"> 3.121 </td>
   <td style="text-align:right;"> 3.121 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1998 </td>
   <td style="text-align:right;"> 2009 </td>
   <td style="text-align:right;"> 3.512 </td>
   <td style="text-align:right;"> 3.512 </td>
   <td style="text-align:right;"> 3.512 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1998 </td>
   <td style="text-align:right;"> 2010 </td>
   <td style="text-align:right;"> 3.727 </td>
   <td style="text-align:right;"> 3.727 </td>
   <td style="text-align:right;"> 3.727 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1998 </td>
   <td style="text-align:right;"> 2011 </td>
   <td style="text-align:right;"> 4.116 </td>
   <td style="text-align:right;"> 4.116 </td>
   <td style="text-align:right;"> 4.116 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1998 </td>
   <td style="text-align:right;"> 2012 </td>
   <td style="text-align:right;"> 4.376 </td>
   <td style="text-align:right;"> 4.376 </td>
   <td style="text-align:right;"> 4.376 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1998 </td>
   <td style="text-align:right;"> 2013 </td>
   <td style="text-align:right;"> 4.711 </td>
   <td style="text-align:right;"> 4.711 </td>
   <td style="text-align:right;"> 4.711 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1998 </td>
   <td style="text-align:right;"> 2014 </td>
   <td style="text-align:right;"> 5.030 </td>
   <td style="text-align:right;"> 5.030 </td>
   <td style="text-align:right;"> 5.030 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1998 </td>
   <td style="text-align:right;"> 2015 </td>
   <td style="text-align:right;"> 5.251 </td>
   <td style="text-align:right;"> 5.251 </td>
   <td style="text-align:right;"> 5.251 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<div class="cell">
<div class="cell-output-display">

<table class="table" style="margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:right;"> Relative Time </th>
   <th style="text-align:right;"> Truth </th>
   <th style="text-align:right;"> POLS </th>
   <th style="text-align:right;"> E-TWFE </th>
   <th style="text-align:right;"> E-TWM </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0.397 </td>
   <td style="text-align:right;"> 0.348 </td>
   <td style="text-align:right;"> 0.348 </td>
   <td style="text-align:right;"> 0.348 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 0.794 </td>
   <td style="text-align:right;"> 0.784 </td>
   <td style="text-align:right;"> 0.784 </td>
   <td style="text-align:right;"> 0.784 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:right;"> 1.191 </td>
   <td style="text-align:right;"> 1.225 </td>
   <td style="text-align:right;"> 1.225 </td>
   <td style="text-align:right;"> 1.225 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 3 </td>
   <td style="text-align:right;"> 1.589 </td>
   <td style="text-align:right;"> 1.650 </td>
   <td style="text-align:right;"> 1.650 </td>
   <td style="text-align:right;"> 1.650 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 4 </td>
   <td style="text-align:right;"> 1.986 </td>
   <td style="text-align:right;"> 1.954 </td>
   <td style="text-align:right;"> 1.954 </td>
   <td style="text-align:right;"> 1.954 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 5 </td>
   <td style="text-align:right;"> 2.383 </td>
   <td style="text-align:right;"> 2.379 </td>
   <td style="text-align:right;"> 2.379 </td>
   <td style="text-align:right;"> 2.379 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 6 </td>
   <td style="text-align:right;"> 2.780 </td>
   <td style="text-align:right;"> 2.777 </td>
   <td style="text-align:right;"> 2.777 </td>
   <td style="text-align:right;"> 2.777 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 7 </td>
   <td style="text-align:right;"> 3.177 </td>
   <td style="text-align:right;"> 3.158 </td>
   <td style="text-align:right;"> 3.158 </td>
   <td style="text-align:right;"> 3.158 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 8 </td>
   <td style="text-align:right;"> 3.574 </td>
   <td style="text-align:right;"> 3.542 </td>
   <td style="text-align:right;"> 3.542 </td>
   <td style="text-align:right;"> 3.542 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 9 </td>
   <td style="text-align:right;"> 3.971 </td>
   <td style="text-align:right;"> 3.888 </td>
   <td style="text-align:right;"> 3.888 </td>
   <td style="text-align:right;"> 3.888 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 10 </td>
   <td style="text-align:right;"> 4.369 </td>
   <td style="text-align:right;"> 4.308 </td>
   <td style="text-align:right;"> 4.308 </td>
   <td style="text-align:right;"> 4.308 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 11 </td>
   <td style="text-align:right;"> 4.766 </td>
   <td style="text-align:right;"> 4.745 </td>
   <td style="text-align:right;"> 4.745 </td>
   <td style="text-align:right;"> 4.745 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 12 </td>
   <td style="text-align:right;"> 5.163 </td>
   <td style="text-align:right;"> 5.158 </td>
   <td style="text-align:right;"> 5.158 </td>
   <td style="text-align:right;"> 5.158 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 13 </td>
   <td style="text-align:right;"> 5.560 </td>
   <td style="text-align:right;"> 5.593 </td>
   <td style="text-align:right;"> 5.593 </td>
   <td style="text-align:right;"> 5.593 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 14 </td>
   <td style="text-align:right;"> 5.957 </td>
   <td style="text-align:right;"> 5.942 </td>
   <td style="text-align:right;"> 5.942 </td>
   <td style="text-align:right;"> 5.942 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 15 </td>
   <td style="text-align:right;"> 6.354 </td>
   <td style="text-align:right;"> 6.412 </td>
   <td style="text-align:right;"> 6.412 </td>
   <td style="text-align:right;"> 6.412 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 16 </td>
   <td style="text-align:right;"> 6.751 </td>
   <td style="text-align:right;"> 6.742 </td>
   <td style="text-align:right;"> 6.742 </td>
   <td style="text-align:right;"> 6.742 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 17 </td>
   <td style="text-align:right;"> 7.149 </td>
   <td style="text-align:right;"> 7.134 </td>
   <td style="text-align:right;"> 7.134 </td>
   <td style="text-align:right;"> 7.134 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 18 </td>
   <td style="text-align:right;"> 9.500 </td>
   <td style="text-align:right;"> 9.503 </td>
   <td style="text-align:right;"> 9.503 </td>
   <td style="text-align:right;"> 9.503 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 19 </td>
   <td style="text-align:right;"> 10.000 </td>
   <td style="text-align:right;"> 9.985 </td>
   <td style="text-align:right;"> 9.985 </td>
   <td style="text-align:right;"> 9.985 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 20 </td>
   <td style="text-align:right;"> 10.500 </td>
   <td style="text-align:right;"> 10.554 </td>
   <td style="text-align:right;"> 10.554 </td>
   <td style="text-align:right;"> 10.554 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 21 </td>
   <td style="text-align:right;"> 11.000 </td>
   <td style="text-align:right;"> 10.909 </td>
   <td style="text-align:right;"> 10.909 </td>
   <td style="text-align:right;"> 10.909 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 22 </td>
   <td style="text-align:right;"> 11.500 </td>
   <td style="text-align:right;"> 11.587 </td>
   <td style="text-align:right;"> 11.587 </td>
   <td style="text-align:right;"> 11.587 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 23 </td>
   <td style="text-align:right;"> 12.000 </td>
   <td style="text-align:right;"> 11.996 </td>
   <td style="text-align:right;"> 11.996 </td>
   <td style="text-align:right;"> 11.996 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 24 </td>
   <td style="text-align:right;"> 12.500 </td>
   <td style="text-align:right;"> 12.545 </td>
   <td style="text-align:right;"> 12.545 </td>
   <td style="text-align:right;"> 12.545 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 25 </td>
   <td style="text-align:right;"> 13.000 </td>
   <td style="text-align:right;"> 13.110 </td>
   <td style="text-align:right;"> 13.110 </td>
   <td style="text-align:right;"> 13.110 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 26 </td>
   <td style="text-align:right;"> 13.500 </td>
   <td style="text-align:right;"> 13.500 </td>
   <td style="text-align:right;"> 13.500 </td>
   <td style="text-align:right;"> 13.500 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<div class="cell">

</div>
<div class="column-screen">
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://graveja0.github.io/HPOL8539-F2022/blog/posts/extended-difference-in-differences_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://graveja0.github.io/HPOL8539-F2022/blog/posts/extended-difference-in-differences_files/figure-html/unnamed-chunk-14-2.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="column-screen">
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://graveja0.github.io/HPOL8539-F2022/blog/posts/extended-difference-in-differences_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://graveja0.github.io/HPOL8539-F2022/blog/posts/extended-difference-in-differences_files/figure-html/unnamed-chunk-15-2.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="column-screen">
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://graveja0.github.io/HPOL8539-F2022/blog/posts/extended-difference-in-differences_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://graveja0.github.io/HPOL8539-F2022/blog/posts/extended-difference-in-differences_files/figure-html/unnamed-chunk-16-2.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="column-screen">
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://graveja0.github.io/HPOL8539-F2022/blog/posts/extended-difference-in-differences_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://graveja0.github.io/HPOL8539-F2022/blog/posts/extended-difference-in-differences_files/figure-html/unnamed-chunk-17-2.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="column-screen">
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://graveja0.github.io/HPOL8539-F2022/blog/posts/extended-difference-in-differences_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://graveja0.github.io/HPOL8539-F2022/blog/posts/extended-difference-in-differences_files/figure-html/unnamed-chunk-18-2.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="column-screen">
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://graveja0.github.io/HPOL8539-F2022/blog/posts/extended-difference-in-differences_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://graveja0.github.io/HPOL8539-F2022/blog/posts/extended-difference-in-differences_files/figure-html/unnamed-chunk-19-2.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">prepare_extended_did_data <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="cf" style="color: #003B4F;">function</span>(df,<span class="at" style="color: #657422;">covariates =</span> <span class="cn" style="color: #8f5902;">NULL</span>) {</span>
<span id="cb8-2">  </span>
<span id="cb8-3">  any_never_treated <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="cf" style="color: #003B4F;">function</span>(df) {</span>
<span id="cb8-4">    n_years <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">max</span>(df<span class="sc" style="color: #5E5E5E;">$</span>year) <span class="sc" style="color: #5E5E5E;">-</span> <span class="fu" style="color: #4758AB;">min</span>(df<span class="sc" style="color: #5E5E5E;">$</span>year) <span class="sc" style="color: #5E5E5E;">+</span> <span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb8-5">    </span>
<span id="cb8-6">    never_treated <span class="ot" style="color: #003B4F;">&lt;-</span> </span>
<span id="cb8-7">      df <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-8">      <span class="fu" style="color: #4758AB;">ungroup</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-9">      <span class="fu" style="color: #4758AB;">filter</span>(w_it<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">0</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-10">      <span class="fu" style="color: #4758AB;">group_by</span>(unit) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-11">      <span class="fu" style="color: #4758AB;">count</span>(year) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-12">      <span class="fu" style="color: #4758AB;">summarise</span>(<span class="at" style="color: #657422;">n =</span> <span class="fu" style="color: #4758AB;">sum</span>(n)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-13">      <span class="fu" style="color: #4758AB;">ungroup</span>()  <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-14">      <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">never_treated =</span> <span class="fu" style="color: #4758AB;">as.integer</span>(n<span class="sc" style="color: #5E5E5E;">==</span>n_years)) </span>
<span id="cb8-15">    </span>
<span id="cb8-16">    any_never_treated <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">max</span>(never_treated<span class="sc" style="color: #5E5E5E;">$</span>never_treated)<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1</span></span>
<span id="cb8-17">    any_never_treated</span>
<span id="cb8-18">  }</span>
<span id="cb8-19">  </span>
<span id="cb8-20">  get_d_star <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="cf" style="color: #003B4F;">function</span>(df) {</span>
<span id="cb8-21">      </span>
<span id="cb8-22">    df <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-23">      <span class="fu" style="color: #4758AB;">select</span>(unit,year,w_it) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-24">      <span class="fu" style="color: #4758AB;">unique</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-25">      <span class="fu" style="color: #4758AB;">filter</span>(w_it<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-26">      <span class="fu" style="color: #4758AB;">group_by</span>(unit) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-27">      <span class="fu" style="color: #4758AB;">filter</span>(year<span class="sc" style="color: #5E5E5E;">==</span><span class="fu" style="color: #4758AB;">min</span>(year)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-28">      <span class="fu" style="color: #4758AB;">select</span>(<span class="sc" style="color: #5E5E5E;">-</span>w_it) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-29">      <span class="fu" style="color: #4758AB;">rename</span>(<span class="at" style="color: #657422;">d =</span> year) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-30">      <span class="fu" style="color: #4758AB;">dummy_cols</span>(<span class="st" style="color: #20794D;">"d"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-31">      <span class="fu" style="color: #4758AB;">select</span>(unit,<span class="fu" style="color: #4758AB;">starts_with</span>(<span class="st" style="color: #20794D;">"d_"</span>)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-32">      <span class="fu" style="color: #4758AB;">right_join</span>(df <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">select</span>(unit) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">unique</span>(),<span class="st" style="color: #20794D;">"unit"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-33">      <span class="fu" style="color: #4758AB;">mutate_at</span>(<span class="fu" style="color: #4758AB;">vars</span>(<span class="fu" style="color: #4758AB;">starts_with</span>(<span class="st" style="color: #20794D;">"d_"</span>)),<span class="sc" style="color: #5E5E5E;">~</span><span class="fu" style="color: #4758AB;">ifelse</span>(<span class="fu" style="color: #4758AB;">is.na</span>(.),<span class="dv" style="color: #AD0000;">0</span>,.)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-34">      <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">never_treated =</span> <span class="fu" style="color: #4758AB;">as.integer</span>(<span class="fu" style="color: #4758AB;">rowSums</span>(.[,<span class="sc" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>])<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">0</span>))  </span>
<span id="cb8-35">  }</span>
<span id="cb8-36">  </span>
<span id="cb8-37">  get_f_star <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="cf" style="color: #003B4F;">function</span>(df) {</span>
<span id="cb8-38">    <span class="fu" style="color: #4758AB;">with</span>(df,<span class="fu" style="color: #4758AB;">table</span>(year,w_it)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">data.frame</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-39">      <span class="fu" style="color: #4758AB;">filter</span>(w_it<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1</span> <span class="sc" style="color: #5E5E5E;">&amp;</span> Freq<span class="sc" style="color: #5E5E5E;">&gt;</span><span class="dv" style="color: #AD0000;">0</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-40">      <span class="fu" style="color: #4758AB;">select</span>(<span class="at" style="color: #657422;">f_star =</span> year)</span>
<span id="cb8-41">  }</span>
<span id="cb8-42">  </span>
<span id="cb8-43">  get_cohort_year_interactions <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="cf" style="color: #003B4F;">function</span>(df,d_star, f_star) {</span>
<span id="cb8-44">    <span class="fu" style="color: #4758AB;">crossing</span>(<span class="at" style="color: #657422;">d =</span> <span class="fu" style="color: #4758AB;">as.numeric</span>(<span class="fu" style="color: #4758AB;">gsub</span>(<span class="st" style="color: #20794D;">"d_"</span>,<span class="st" style="color: #20794D;">""</span>,<span class="fu" style="color: #4758AB;">grep</span>(<span class="st" style="color: #20794D;">"d_"</span>,<span class="fu" style="color: #4758AB;">colnames</span>(d_star),<span class="at" style="color: #657422;">value=</span><span class="cn" style="color: #8f5902;">TRUE</span>))),<span class="at" style="color: #657422;">f =</span> <span class="fu" style="color: #4758AB;">as.numeric</span>(<span class="fu" style="color: #4758AB;">paste0</span>(f_star<span class="sc" style="color: #5E5E5E;">$</span>f_star))) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-45">      <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">value =</span> <span class="fu" style="color: #4758AB;">as.numeric</span>(f<span class="sc" style="color: #5E5E5E;">&gt;=</span>d)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-46">      <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">f =</span> <span class="fu" style="color: #4758AB;">paste0</span>(<span class="st" style="color: #20794D;">"f_"</span>,f)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-47">      <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">d =</span> <span class="fu" style="color: #4758AB;">paste0</span>(<span class="st" style="color: #20794D;">"d_"</span>,d)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-48">      <span class="fu" style="color: #4758AB;">spread</span>(f,value) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-49">      <span class="fu" style="color: #4758AB;">gather</span>(f,value,<span class="sc" style="color: #5E5E5E;">-</span>d) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-50">      <span class="fu" style="color: #4758AB;">filter</span>(value<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-51">      <span class="fu" style="color: #4758AB;">arrange</span>(d,f) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-52">      <span class="fu" style="color: #4758AB;">select</span>(<span class="sc" style="color: #5E5E5E;">-</span>value) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-53">      <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">i =</span> <span class="fu" style="color: #4758AB;">paste0</span>(<span class="st" style="color: #20794D;">"I("</span>,d,<span class="st" style="color: #20794D;">"*"</span>,f,<span class="st" style="color: #20794D;">")"</span>))</span>
<span id="cb8-54">  }</span>
<span id="cb8-55">  </span>
<span id="cb8-56">  is_there_any_never_treated <span class="ot" style="color: #003B4F;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">any_never_treated</span>()</span>
<span id="cb8-57">  d_star <span class="ot" style="color: #003B4F;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">get_d_star</span>()</span>
<span id="cb8-58">  d_star_names <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">colnames</span>(d_star)[<span class="sc" style="color: #5E5E5E;">-</span><span class="fu" style="color: #4758AB;">grep</span>(<span class="st" style="color: #20794D;">"unit|never_treated"</span>,<span class="fu" style="color: #4758AB;">colnames</span>(d_star))]</span>
<span id="cb8-59">  f_star <span class="ot" style="color: #003B4F;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">get_f_star</span>()</span>
<span id="cb8-60">  cohort_year_interactions <span class="ot" style="color: #003B4F;">&lt;-</span> df <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">get_cohort_year_interactions</span>(., <span class="at" style="color: #657422;">d_star =</span> d_star, <span class="at" style="color: #657422;">f_star =</span> f_star)</span>
<span id="cb8-61">  </span>
<span id="cb8-62">  df_final_ <span class="ot" style="color: #003B4F;">&lt;-</span> </span>
<span id="cb8-63">    df <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-64">    <span class="fu" style="color: #4758AB;">select</span>(unit,year,y_it,<span class="fu" style="color: #4758AB;">starts_with</span>(<span class="st" style="color: #20794D;">"x_i"</span>),w_it,covariates) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-65">    <span class="fu" style="color: #4758AB;">left_join</span>(d_star,<span class="st" style="color: #20794D;">"unit"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-66">    <span class="fu" style="color: #4758AB;">mutate_at</span>(<span class="fu" style="color: #4758AB;">vars</span>(<span class="fu" style="color: #4758AB;">starts_with</span>(<span class="st" style="color: #20794D;">"d_"</span>)),<span class="sc" style="color: #5E5E5E;">~</span><span class="fu" style="color: #4758AB;">ifelse</span>(<span class="fu" style="color: #4758AB;">is.na</span>(.),<span class="dv" style="color: #AD0000;">0</span>,.)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-67">    <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">f =</span> <span class="fu" style="color: #4758AB;">ifelse</span>(year <span class="sc" style="color: #5E5E5E;">%in%</span> f_star<span class="sc" style="color: #5E5E5E;">$</span>f_star,year,<span class="cn" style="color: #8f5902;">NA</span>)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-68">    <span class="fu" style="color: #4758AB;">dummy_cols</span>(<span class="st" style="color: #20794D;">"f"</span>,<span class="at" style="color: #657422;">ignore_na=</span><span class="cn" style="color: #8f5902;">TRUE</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-69">    <span class="fu" style="color: #4758AB;">mutate_at</span>(<span class="fu" style="color: #4758AB;">vars</span>(<span class="fu" style="color: #4758AB;">starts_with</span>(<span class="st" style="color: #20794D;">"f_"</span>)),<span class="sc" style="color: #5E5E5E;">~</span><span class="fu" style="color: #4758AB;">ifelse</span>(<span class="fu" style="color: #4758AB;">is.na</span>(.),<span class="dv" style="color: #AD0000;">0</span>,.))  <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-70">    <span class="fu" style="color: #4758AB;">dummy_cols</span>(<span class="st" style="color: #20794D;">"year"</span>,<span class="at" style="color: #657422;">ignore_na=</span><span class="cn" style="color: #8f5902;">TRUE</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-71">    <span class="fu" style="color: #4758AB;">select</span>(<span class="sc" style="color: #5E5E5E;">-</span>f)</span>
<span id="cb8-72">  </span>
<span id="cb8-73">  <span class="cf" style="color: #003B4F;">if</span> (<span class="sc" style="color: #5E5E5E;">!</span><span class="fu" style="color: #4758AB;">is.null</span>(covariates)) {</span>
<span id="cb8-74">    <span class="cf" style="color: #003B4F;">for</span> (.x <span class="cf" style="color: #003B4F;">in</span> covariates) {</span>
<span id="cb8-75">      covariate_means <span class="ot" style="color: #003B4F;">&lt;-</span> </span>
<span id="cb8-76">        df_final_ <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-77">        <span class="fu" style="color: #4758AB;">select_at</span>(<span class="fu" style="color: #4758AB;">vars</span>(unit,.x,<span class="fu" style="color: #4758AB;">starts_with</span>(<span class="st" style="color: #20794D;">"d_"</span>))) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-78">        <span class="fu" style="color: #4758AB;">pivot_longer</span>(<span class="at" style="color: #657422;">cols =</span> <span class="fu" style="color: #4758AB;">starts_with</span>(<span class="st" style="color: #20794D;">"d_"</span>)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-79">        <span class="fu" style="color: #4758AB;">filter</span>(value<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-80">        <span class="fu" style="color: #4758AB;">rename</span>(<span class="at" style="color: #657422;">cohort =</span> name) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-81">        <span class="fu" style="color: #4758AB;">select</span>(<span class="sc" style="color: #5E5E5E;">-</span>value) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-82">        <span class="fu" style="color: #4758AB;">group_by</span>(cohort) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-83">        <span class="fu" style="color: #4758AB;">summarise_at</span>(<span class="fu" style="color: #4758AB;">vars</span>(.x),mean,<span class="at" style="color: #657422;">na.rm=</span><span class="cn" style="color: #8f5902;">TRUE</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-84">        <span class="fu" style="color: #4758AB;">mutate</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-85">        <span class="fu" style="color: #4758AB;">gather</span>(covar,mean,<span class="sc" style="color: #5E5E5E;">-</span>cohort) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-86">        <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">covar =</span> <span class="fu" style="color: #4758AB;">paste0</span>(covar,<span class="st" style="color: #20794D;">"_dm"</span>)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-87">        <span class="fu" style="color: #4758AB;">unite</span>(covar,covar,cohort) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-88">        <span class="fu" style="color: #4758AB;">spread</span>(covar,mean)</span>
<span id="cb8-89">      </span>
<span id="cb8-90">      tmp <span class="ot" style="color: #003B4F;">&lt;-</span> </span>
<span id="cb8-91">        df_final_ <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-92">        <span class="fu" style="color: #4758AB;">select</span>(unit,year,<span class="at" style="color: #657422;">tmp =</span> .x) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-93">        <span class="fu" style="color: #4758AB;">left_join</span>(covariate_means, <span class="at" style="color: #657422;">by =</span> <span class="fu" style="color: #4758AB;">character</span>()) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-94">        <span class="fu" style="color: #4758AB;">mutate_at</span>(<span class="fu" style="color: #4758AB;">vars</span>(<span class="fu" style="color: #4758AB;">colnames</span>(covariate_means)),<span class="sc" style="color: #5E5E5E;">~</span>(.data<span class="sc" style="color: #5E5E5E;">$</span>tmp <span class="sc" style="color: #5E5E5E;">-</span> .)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-95">        <span class="fu" style="color: #4758AB;">select</span>(unit,year,<span class="fu" style="color: #4758AB;">contains</span>(<span class="st" style="color: #20794D;">"_dm_"</span>))</span>
<span id="cb8-96">      </span>
<span id="cb8-97">      df_final_ <span class="ot" style="color: #003B4F;">&lt;-</span> </span>
<span id="cb8-98">        df_final_ <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb8-99">        <span class="fu" style="color: #4758AB;">left_join</span>(tmp,<span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"unit"</span>,<span class="st" style="color: #20794D;">"year"</span>))</span>
<span id="cb8-100">      </span>
<span id="cb8-101">    }</span>
<span id="cb8-102">    df_final <span class="ot" style="color: #003B4F;">&lt;-</span> df_final_</span>
<span id="cb8-103">  } <span class="cf" style="color: #003B4F;">else</span> {</span>
<span id="cb8-104">    df_final <span class="ot" style="color: #003B4F;">&lt;-</span> df_final_</span>
<span id="cb8-105">    ff_twfe <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">as.formula</span>(<span class="fu" style="color: #4758AB;">paste0</span>(<span class="st" style="color: #20794D;">"y_it ~"</span>,<span class="fu" style="color: #4758AB;">paste0</span>(cohort_year_interactions<span class="sc" style="color: #5E5E5E;">$</span>i,<span class="at" style="color: #657422;">collapse=</span><span class="st" style="color: #20794D;">"+"</span>),<span class="st" style="color: #20794D;">"+ factor(year) | unit"</span>))</span>
<span id="cb8-106">    ff_pols <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">as.formula</span>(<span class="fu" style="color: #4758AB;">paste0</span>(<span class="st" style="color: #20794D;">"y_it ~"</span>,<span class="fu" style="color: #4758AB;">paste0</span>(cohort_year_interactions<span class="sc" style="color: #5E5E5E;">$</span>i,<span class="at" style="color: #657422;">collapse=</span><span class="st" style="color: #20794D;">"+"</span>),<span class="st" style="color: #20794D;">"+"</span>,<span class="fu" style="color: #4758AB;">paste0</span>(<span class="fu" style="color: #4758AB;">grep</span>(<span class="st" style="color: #20794D;">"^d_"</span>,<span class="fu" style="color: #4758AB;">colnames</span>(df_final), <span class="at" style="color: #657422;">value=</span><span class="cn" style="color: #8f5902;">TRUE</span>),<span class="at" style="color: #657422;">collapse=</span><span class="st" style="color: #20794D;">"+"</span>),<span class="st" style="color: #20794D;">"+ factor(year)"</span>))</span>
<span id="cb8-107">    ff_re <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">as.formula</span>(<span class="fu" style="color: #4758AB;">paste0</span>(<span class="st" style="color: #20794D;">"y_it ~"</span>,<span class="fu" style="color: #4758AB;">paste0</span>(cohort_year_interactions<span class="sc" style="color: #5E5E5E;">$</span>i,<span class="at" style="color: #657422;">collapse=</span><span class="st" style="color: #20794D;">"+"</span>),<span class="st" style="color: #20794D;">"+"</span>,<span class="fu" style="color: #4758AB;">paste0</span>(<span class="fu" style="color: #4758AB;">grep</span>(<span class="st" style="color: #20794D;">"^d_"</span>,<span class="fu" style="color: #4758AB;">colnames</span>(df_final), <span class="at" style="color: #657422;">value=</span><span class="cn" style="color: #8f5902;">TRUE</span>),<span class="at" style="color: #657422;">collapse=</span><span class="st" style="color: #20794D;">"+"</span>),<span class="st" style="color: #20794D;">"+ factor(year) + (1| unit)"</span>))</span>
<span id="cb8-108">  }</span>
<span id="cb8-109">  </span>
<span id="cb8-110">  <span class="fu" style="color: #4758AB;">return</span>(<span class="fu" style="color: #4758AB;">list</span>(<span class="at" style="color: #657422;">df =</span> df_final, <span class="at" style="color: #657422;">ff_pols =</span> ff_pols, <span class="at" style="color: #657422;">ff_twfe =</span> ff_twfe, <span class="at" style="color: #657422;">ff_re =</span> ff_re))</span>
<span id="cb8-111">}</span></code></pre></div>
</div>


</section>

 ]]></description>
  <guid>https://graveja0.github.io/HPOL8539-F2022/blog/posts/extended-difference-in-differences.html</guid>
  <pubDate>Wed, 09 Nov 2022 11:57:11 GMT</pubDate>
</item>
<item>
  <title>Quantile Treatment Effects</title>
  <dc:creator>Advanced Program and Policy Evaluation</dc:creator>
  <link>https://graveja0.github.io/HPOL8539-F2022/blog/posts/quantile-treatment-effects.html</link>
  <description><![CDATA[ 



<div class="cell">

</div>
<p>The objective of this workbook is to work through estimation of quantile treatment effects using the Lalonde experimental and observational data.</p>
<section id="description-of-data" class="level2">
<h2 class="anchored" data-anchor-id="description-of-data">Description of Data</h2>
<p>Our example data will be drawn from the infamous Lalonde study:</p>
<ul>
<li>Robert Lalonde, “Evaluating the Econometric Evaluations of Training Programs”, American Economic Review, Vol. 76, pp.&nbsp;604-620</li>
</ul>
<p>From <a href="https://www.jstor.org/stable/2669919">Dehejia and Wahba (1999)</a>:</p>
<blockquote class="blockquote">
<p>Lalonde estimated the impact of the National Supported Work (NSW) Demonstration, a labor training program, on postintervention income levels. He used data from a randomized evaluation of the program and examined the extent to which nonexperimental estimators can replicate the unbiased experimental estimate of the treatment impact when applied to a composite dataset of experimental treatment units and nonexperimental comparison units.</p>
</blockquote>
</section>
<section id="explore-data" class="level1">
<h1>Explore Data</h1>
<section id="experimental-data" class="level2">
<h2 class="anchored" data-anchor-id="experimental-data">Experimental Data</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1">lalonde.exp <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb1-2">  <span class="fu" style="color: #4758AB;">group_by</span>(treat) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb1-3">  <span class="fu" style="color: #4758AB;">skim</span>()</span></code></pre></div>
<div class="cell-output-display">

<table style="width: auto;" class="table table-condensed">
<caption>
Data summary
</caption>
<tbody>
<tr>
<td style="text-align:left;">
Name
</td>
<td style="text-align:left;">
Piped data
</td>
</tr>
<tr>
<td style="text-align:left;">
Number of rows
</td>
<td style="text-align:left;">
445
</td>
</tr>
<tr>
<td style="text-align:left;">
Number of columns
</td>
<td style="text-align:left;">
13
</td>
</tr>
<tr>
<td style="text-align:left;">
_______________________
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
Column type frequency:
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
numeric
</td>
<td style="text-align:left;">
12
</td>
</tr>
<tr>
<td style="text-align:left;">
________________________
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
Group variables
</td>
<td style="text-align:left;">
treat
</td>
</tr>
</tbody>

</table>
<p><strong>Variable type: numeric</strong></p>

<table>
<thead>
<tr>
<th style="text-align:left;">
skim_variable
</th>
<th style="text-align:right;">
treat
</th>
<th style="text-align:right;">
n_missing
</th>
<th style="text-align:right;">
complete_rate
</th>
<th style="text-align:right;">
mean
</th>
<th style="text-align:right;">
sd
</th>
<th style="text-align:right;">
p0
</th>
<th style="text-align:right;">
p25
</th>
<th style="text-align:right;">
p50
</th>
<th style="text-align:right;">
p75
</th>
<th style="text-align:right;">
p100
</th>
<th style="text-align:left;">
hist
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
25.05
</td>
<td style="text-align:right;">
7.06
</td>
<td style="text-align:right;">
17
</td>
<td style="text-align:right;">
19.00
</td>
<td style="text-align:right;">
24.0
</td>
<td style="text-align:right;">
28.00
</td>
<td style="text-align:right;">
55
</td>
<td style="text-align:left;">
▇▅▂▁▁
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
25.82
</td>
<td style="text-align:right;">
7.16
</td>
<td style="text-align:right;">
17
</td>
<td style="text-align:right;">
20.00
</td>
<td style="text-align:right;">
25.0
</td>
<td style="text-align:right;">
29.00
</td>
<td style="text-align:right;">
48
</td>
<td style="text-align:left;">
▇▇▂▁▁
</td>
</tr>
<tr>
<td style="text-align:left;">
education
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
10.09
</td>
<td style="text-align:right;">
1.61
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
9.00
</td>
<td style="text-align:right;">
10.0
</td>
<td style="text-align:right;">
11.00
</td>
<td style="text-align:right;">
14
</td>
<td style="text-align:left;">
▁▁▃▇▂
</td>
</tr>
<tr>
<td style="text-align:left;">
education
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
10.35
</td>
<td style="text-align:right;">
2.01
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
9.00
</td>
<td style="text-align:right;">
11.0
</td>
<td style="text-align:right;">
12.00
</td>
<td style="text-align:right;">
16
</td>
<td style="text-align:left;">
▁▂▇▃▁
</td>
</tr>
<tr>
<td style="text-align:left;">
black
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.83
</td>
<td style="text-align:right;">
0.38
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
▂▁▁▁▇
</td>
</tr>
<tr>
<td style="text-align:left;">
black
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.84
</td>
<td style="text-align:right;">
0.36
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
▂▁▁▁▇
</td>
</tr>
<tr>
<td style="text-align:left;">
hispanic
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.11
</td>
<td style="text-align:right;">
0.31
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
▇▁▁▁▁
</td>
</tr>
<tr>
<td style="text-align:left;">
hispanic
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.06
</td>
<td style="text-align:right;">
0.24
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
▇▁▁▁▁
</td>
</tr>
<tr>
<td style="text-align:left;">
married
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.15
</td>
<td style="text-align:right;">
0.36
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
▇▁▁▁▂
</td>
</tr>
<tr>
<td style="text-align:left;">
married
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.19
</td>
<td style="text-align:right;">
0.39
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
▇▁▁▁▂
</td>
</tr>
<tr>
<td style="text-align:left;">
nodegree
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.83
</td>
<td style="text-align:right;">
0.37
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
▂▁▁▁▇
</td>
</tr>
<tr>
<td style="text-align:left;">
nodegree
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.71
</td>
<td style="text-align:right;">
0.46
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
▃▁▁▁▇
</td>
</tr>
<tr>
<td style="text-align:left;">
re74
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2107.03
</td>
<td style="text-align:right;">
5687.91
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
139.42
</td>
<td style="text-align:right;">
39571
</td>
<td style="text-align:left;">
▇▁▁▁▁
</td>
</tr>
<tr>
<td style="text-align:left;">
re74
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2095.57
</td>
<td style="text-align:right;">
4886.62
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
1291.47
</td>
<td style="text-align:right;">
35040
</td>
<td style="text-align:left;">
▇▁▁▁▁
</td>
</tr>
<tr>
<td style="text-align:left;">
re75
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1266.91
</td>
<td style="text-align:right;">
3102.98
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
650.10
</td>
<td style="text-align:right;">
23032
</td>
<td style="text-align:left;">
▇▁▁▁▁
</td>
</tr>
<tr>
<td style="text-align:left;">
re75
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1532.06
</td>
<td style="text-align:right;">
3219.25
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
1817.28
</td>
<td style="text-align:right;">
25142
</td>
<td style="text-align:left;">
▇▁▁▁▁
</td>
</tr>
<tr>
<td style="text-align:left;">
re78
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
4554.80
</td>
<td style="text-align:right;">
5483.84
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
3138.8
</td>
<td style="text-align:right;">
7288.42
</td>
<td style="text-align:right;">
39484
</td>
<td style="text-align:left;">
▇▂▁▁▁
</td>
</tr>
<tr>
<td style="text-align:left;">
re78
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
6349.15
</td>
<td style="text-align:right;">
7867.40
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
485.23
</td>
<td style="text-align:right;">
4232.3
</td>
<td style="text-align:right;">
9643.00
</td>
<td style="text-align:right;">
60308
</td>
<td style="text-align:left;">
▇▁▁▁▁
</td>
</tr>
<tr>
<td style="text-align:left;">
u74
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.75
</td>
<td style="text-align:right;">
0.43
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.75
</td>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
▂▁▁▁▇
</td>
</tr>
<tr>
<td style="text-align:left;">
u74
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.71
</td>
<td style="text-align:right;">
0.46
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
▃▁▁▁▇
</td>
</tr>
<tr>
<td style="text-align:left;">
u75
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.68
</td>
<td style="text-align:right;">
0.47
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
▃▁▁▁▇
</td>
</tr>
<tr>
<td style="text-align:left;">
u75
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.60
</td>
<td style="text-align:right;">
0.49
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.00
</td>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
1.00
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
▅▁▁▁▇
</td>
</tr>
<tr>
<td style="text-align:left;">
id
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
315.50
</td>
<td style="text-align:right;">
75.20
</td>
<td style="text-align:right;">
186
</td>
<td style="text-align:right;">
250.75
</td>
<td style="text-align:right;">
315.5
</td>
<td style="text-align:right;">
380.25
</td>
<td style="text-align:right;">
445
</td>
<td style="text-align:left;">
▇▇▇▇▇
</td>
</tr>
<tr>
<td style="text-align:left;">
id
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
93.00
</td>
<td style="text-align:right;">
53.55
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
47.00
</td>
<td style="text-align:right;">
93.0
</td>
<td style="text-align:right;">
139.00
</td>
<td style="text-align:right;">
185
</td>
<td style="text-align:left;">
▇▇▇▇▇
</td>
</tr>
</tbody>

</table>
</div>
</div>
</section>
<section id="observational-panel-data-from-the-panel-survey-of-income-dynamics" class="level2">
<h2 class="anchored" data-anchor-id="observational-panel-data-from-the-panel-survey-of-income-dynamics">Observational (Panel) Data from the Panel Survey of Income Dynamics</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1">lalonde.psid.panel <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb2-2">  <span class="fu" style="color: #4758AB;">group_by</span>(treat) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb2-3">  <span class="fu" style="color: #4758AB;">skim</span>()</span></code></pre></div>
<div class="cell-output-display">

<table style="width: auto;" class="table table-condensed">
<caption>
Data summary
</caption>
<tbody>
<tr>
<td style="text-align:left;">
Name
</td>
<td style="text-align:left;">
Piped data
</td>
</tr>
<tr>
<td style="text-align:left;">
Number of rows
</td>
<td style="text-align:left;">
8025
</td>
</tr>
<tr>
<td style="text-align:left;">
Number of columns
</td>
<td style="text-align:left;">
13
</td>
</tr>
<tr>
<td style="text-align:left;">
_______________________
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
Column type frequency:
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
character
</td>
<td style="text-align:left;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
numeric
</td>
<td style="text-align:left;">
11
</td>
</tr>
<tr>
<td style="text-align:left;">
________________________
</td>
<td style="text-align:left;">
</td>
</tr>
<tr>
<td style="text-align:left;">
Group variables
</td>
<td style="text-align:left;">
treat
</td>
</tr>
</tbody>

</table>
<p><strong>Variable type: character</strong></p>

<table>
<thead>
<tr>
<th style="text-align:left;">
skim_variable
</th>
<th style="text-align:right;">
treat
</th>
<th style="text-align:right;">
n_missing
</th>
<th style="text-align:right;">
complete_rate
</th>
<th style="text-align:right;">
min
</th>
<th style="text-align:right;">
max
</th>
<th style="text-align:right;">
empty
</th>
<th style="text-align:right;">
n_unique
</th>
<th style="text-align:right;">
whitespace
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
uniqueid
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
10
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
7470
</td>
<td style="text-align:right;">
0
</td>
</tr>
<tr>
<td style="text-align:left;">
uniqueid
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
8
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
555
</td>
<td style="text-align:right;">
0
</td>
</tr>
</tbody>

</table>
<p><strong>Variable type: numeric</strong></p>

<table>
<thead>
<tr>
<th style="text-align:left;">
skim_variable
</th>
<th style="text-align:right;">
treat
</th>
<th style="text-align:right;">
n_missing
</th>
<th style="text-align:right;">
complete_rate
</th>
<th style="text-align:right;">
mean
</th>
<th style="text-align:right;">
sd
</th>
<th style="text-align:right;">
p0
</th>
<th style="text-align:right;">
p25
</th>
<th style="text-align:right;">
p50
</th>
<th style="text-align:right;">
p75
</th>
<th style="text-align:right;">
p100
</th>
<th style="text-align:left;">
hist
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
year
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1975.67
</td>
<td style="text-align:right;">
1.70
</td>
<td style="text-align:right;">
1974
</td>
<td style="text-align:right;">
1974
</td>
<td style="text-align:right;">
1975.0
</td>
<td style="text-align:right;">
1978.0
</td>
<td style="text-align:right;">
1978
</td>
<td style="text-align:left;">
▇▇▁▁▇
</td>
</tr>
<tr>
<td style="text-align:left;">
year
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1975.67
</td>
<td style="text-align:right;">
1.70
</td>
<td style="text-align:right;">
1974
</td>
<td style="text-align:right;">
1974
</td>
<td style="text-align:right;">
1975.0
</td>
<td style="text-align:right;">
1978.0
</td>
<td style="text-align:right;">
1978
</td>
<td style="text-align:left;">
▇▇▁▁▇
</td>
</tr>
<tr>
<td style="text-align:left;">
id
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2035.05
</td>
<td style="text-align:right;">
2876.75
</td>
<td style="text-align:right;">
186
</td>
<td style="text-align:right;">
808
</td>
<td style="text-align:right;">
1430.5
</td>
<td style="text-align:right;">
2053.0
</td>
<td style="text-align:right;">
23100
</td>
<td style="text-align:left;">
▇▁▁▁▁
</td>
</tr>
<tr>
<td style="text-align:left;">
id
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
93.00
</td>
<td style="text-align:right;">
53.45
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
47
</td>
<td style="text-align:right;">
93.0
</td>
<td style="text-align:right;">
139.0
</td>
<td style="text-align:right;">
185
</td>
<td style="text-align:left;">
▇▇▇▇▇
</td>
</tr>
<tr>
<td style="text-align:left;">
re
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
20015.33
</td>
<td style="text-align:right;">
14260.04
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
10742
</td>
<td style="text-align:right;">
19210.5
</td>
<td style="text-align:right;">
27337.9
</td>
<td style="text-align:right;">
156653
</td>
<td style="text-align:left;">
▇▂▁▁▁
</td>
</tr>
<tr>
<td style="text-align:left;">
re
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
3325.59
</td>
<td style="text-align:right;">
6046.71
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
4574.5
</td>
<td style="text-align:right;">
60308
</td>
<td style="text-align:left;">
▇▁▁▁▁
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
34.85
</td>
<td style="text-align:right;">
10.44
</td>
<td style="text-align:right;">
18
</td>
<td style="text-align:right;">
26
</td>
<td style="text-align:right;">
33.0
</td>
<td style="text-align:right;">
44.0
</td>
<td style="text-align:right;">
55
</td>
<td style="text-align:left;">
▇▇▆▅▅
</td>
</tr>
<tr>
<td style="text-align:left;">
age
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
25.82
</td>
<td style="text-align:right;">
7.14
</td>
<td style="text-align:right;">
17
</td>
<td style="text-align:right;">
20
</td>
<td style="text-align:right;">
25.0
</td>
<td style="text-align:right;">
29.0
</td>
<td style="text-align:right;">
48
</td>
<td style="text-align:left;">
▇▇▂▁▁
</td>
</tr>
<tr>
<td style="text-align:left;">
education
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
12.12
</td>
<td style="text-align:right;">
3.08
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
11
</td>
<td style="text-align:right;">
12.0
</td>
<td style="text-align:right;">
14.0
</td>
<td style="text-align:right;">
17
</td>
<td style="text-align:left;">
▁▁▃▇▅
</td>
</tr>
<tr>
<td style="text-align:left;">
education
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
10.35
</td>
<td style="text-align:right;">
2.01
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
9
</td>
<td style="text-align:right;">
11.0
</td>
<td style="text-align:right;">
12.0
</td>
<td style="text-align:right;">
16
</td>
<td style="text-align:left;">
▁▂▇▃▁
</td>
</tr>
<tr>
<td style="text-align:left;">
black
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.25
</td>
<td style="text-align:right;">
0.43
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
▇▁▁▁▃
</td>
</tr>
<tr>
<td style="text-align:left;">
black
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.84
</td>
<td style="text-align:right;">
0.36
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
▂▁▁▁▇
</td>
</tr>
<tr>
<td style="text-align:left;">
hispanic
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.03
</td>
<td style="text-align:right;">
0.18
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
▇▁▁▁▁
</td>
</tr>
<tr>
<td style="text-align:left;">
hispanic
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.06
</td>
<td style="text-align:right;">
0.24
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
▇▁▁▁▁
</td>
</tr>
<tr>
<td style="text-align:left;">
married
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.87
</td>
<td style="text-align:right;">
0.34
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
▁▁▁▁▇
</td>
</tr>
<tr>
<td style="text-align:left;">
married
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.19
</td>
<td style="text-align:right;">
0.39
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
▇▁▁▁▂
</td>
</tr>
<tr>
<td style="text-align:left;">
nodegree
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.31
</td>
<td style="text-align:right;">
0.46
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
▇▁▁▁▃
</td>
</tr>
<tr>
<td style="text-align:left;">
nodegree
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.71
</td>
<td style="text-align:right;">
0.46
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
▃▁▁▁▇
</td>
</tr>
<tr>
<td style="text-align:left;">
u74
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.09
</td>
<td style="text-align:right;">
0.28
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
▇▁▁▁▁
</td>
</tr>
<tr>
<td style="text-align:left;">
u74
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.71
</td>
<td style="text-align:right;">
0.46
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
▃▁▁▁▇
</td>
</tr>
<tr>
<td style="text-align:left;">
u75
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.10
</td>
<td style="text-align:right;">
0.30
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
0.0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
▇▁▁▁▁
</td>
</tr>
<tr>
<td style="text-align:left;">
u75
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0.60
</td>
<td style="text-align:right;">
0.49
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
1.0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
▅▁▁▁▇
</td>
</tr>
</tbody>

</table>
</div>
</div>
<p>A key takeaway is that the experimental data is reasonably balanced across treated and control units (not surprisingly) but the observational data is not.</p>
</section>
</section>
<section id="evaluate-the-job-training-program" class="level1 page-columns page-full">
<h1>Evaluate the Job Training Program</h1>
<section id="quantile-treatment-effect-estimation-in-experimental-data" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="quantile-treatment-effect-estimation-in-experimental-data">Quantile Treatment Effect Estimation in Experimental Data</h2>
<p>Our first exercise will evaluate the effect of the training program using the experimental data. Because we have a randomized experiment, we can simply compare the treated and untreated outcomes in the post-treatment period.</p>
<p>Let’s first take a look at the distribution of outcomes by group:</p>
<div class="column-body-outset">
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-histogram-exp" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://graveja0.github.io/HPOL8539-F2022/blog/posts/quantile-treatment-effects_files/figure-html/fig-histogram-exp-1.png" class="img-fluid figure-img" width="960"></p>
<p></p><figcaption class="figure-caption">Figure 1: Histogram of Earnings Outcome in Experimental Data, by Treatment Status and Year</figcaption><p></p>
</figure>
</div>
</div>
</div>
</div>
<p>We next take a difference in means to obtain an estimate of the average treatment effect on the treated:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1">lalonde.exp <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb3-2">  <span class="fu" style="color: #4758AB;">group_by</span>(treat) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb3-3">  <span class="fu" style="color: #4758AB;">summarise</span>(<span class="at" style="color: #657422;">mean_outcome =</span> <span class="fu" style="color: #4758AB;">mean</span>(re78)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb3-4">  <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">att =</span> mean_outcome <span class="sc" style="color: #5E5E5E;">-</span> <span class="fu" style="color: #4758AB;">lag</span>(mean_outcome)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb3-5">  <span class="fu" style="color: #4758AB;">kable</span>(<span class="at" style="color: #657422;">digits =</span> <span class="dv" style="color: #AD0000;">2</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">kable_styling</span>()</span></code></pre></div>
<div class="cell-output-display">

<table class="table" style="margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:right;"> treat </th>
   <th style="text-align:right;"> mean_outcome </th>
   <th style="text-align:right;"> att </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 4554.8 </td>
   <td style="text-align:right;"> NA </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:right;"> 6349.1 </td>
   <td style="text-align:right;"> 1794.3 </td>
  </tr>
</tbody>
</table>

</div>
</div>
<p>Suppose we wanted to estimate treatment effects at different quantiles of the outcome distribution. To get a sense of where these effects may occur, we can plot the <strong>empirical cumulative distribution function (eCDF)</strong> for each group:</p>
<div class="column-body-outset">
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div id="fig-cdf-exp" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://graveja0.github.io/HPOL8539-F2022/blog/posts/quantile-treatment-effects_files/figure-html/fig-cdf-exp-1.png" class="img-fluid figure-img" width="960"></p>
<p></p><figcaption class="figure-caption">Figure 2: Empirical CDF of Outcome in Experimental Data, by Treatment Status and Year</figcaption><p></p>
</figure>
</div>
</div>
</div>
</div>
<p>We see here that the two distributions have separated a bit, though there are regions where they essentially overlap. Just shy of the 25th percentile, for example, the two distributions overlap at around $0 in income; there doesn’t appear to be any change in earnings for treated individuals within the bottom quarter of the income distribution.</p>
<section id="estimating-quantile-treatment-effects" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="estimating-quantile-treatment-effects">Estimating Quantile Treatment Effects</h3>
<p>Suppose we wanted to estimate the difference at some quantile of interest (e.g., the 25th percentile or the 75th percentile). How would we go about doing this? Essentially, for a selected quantile (e.g., 75th percentile), we need to measure the horizontal distance between the two curves in Figure&nbsp;2.</p>
<p>To build up an estimator that we can apply in our data, we first need to introduce some notation.</p>
<p>Define <img src="https://latex.codecogs.com/png.latex?F_%7BY(W)wt%7D(y)"> as the potential outcome distribution function for an individual receiving treatment <img src="https://latex.codecogs.com/png.latex?W%20%5Cin%200,1">, and who is observed to be in treatment group <img src="https://latex.codecogs.com/png.latex?w"> at time <img src="https://latex.codecogs.com/png.latex?t">.</p>
<p>For example:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?F_%7BY(1)11%7D(y)"> is the distribution function for the outcome distribution under treatment for treated individuals in the post-treatment period.</li>
<li><img src="https://latex.codecogs.com/png.latex?F_%7BY(0)01%7D(y)"> is the distribution function for the outcome distribution under non-treatment for non-treated individuals in the post-treatment period.</li>
</ul>
<p>We can supply each of these distribution functions a value of the outcome <img src="https://latex.codecogs.com/png.latex?y">, and it will tell us at what quantile <img src="https://latex.codecogs.com/png.latex?%5Ctau"> in the distribution that value of <img src="https://latex.codecogs.com/png.latex?y"> maps to. For example, plugging in a value of $2,000 might tell us that this value is at the 50th percentile (median) of a given outcome distribution.</p>
<p>Stepping back from the notation a bit, note that these two functions are essentially what we already plotted in Figure&nbsp;2 above. How do we calculate these functions in R?</p>
<p>Fortunately, base R has a defined function (<code>ecdf()</code>) that allows us to do this easily. Let’s define empirical distribution functions for the treated and untreated groups in the experimental Lalonde data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1">y11 <span class="ot" style="color: #003B4F;">&lt;-</span> lalonde.exp <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">filter</span>(treat<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">pull</span>(re78)</span>
<span id="cb4-2">y01 <span class="ot" style="color: #003B4F;">&lt;-</span> lalonde.exp <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">filter</span>(treat<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">0</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">pull</span>(re78)</span>
<span id="cb4-3"></span>
<span id="cb4-4">eF11 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">ecdf</span>(y11)</span>
<span id="cb4-5">eF01 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">ecdf</span>(y01)</span>
<span id="cb4-6">             </span>
<span id="cb4-7"><span class="fu" style="color: #4758AB;">eF11</span>(<span class="dv" style="color: #AD0000;">2000</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.38919</code></pre>
</div>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><span class="fu" style="color: #4758AB;">eF01</span>(<span class="dv" style="color: #AD0000;">2000</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.45</code></pre>
</div>
</div>
<p>We see in the calculations above that earnings of $2,000 would place you at the 39th percentile of the treated group’s post-intervention outcome distribution, and at the 45th percentile of the untreated groups distribution.</p>
<p>We next need to go one step further, however, and define the <em>inverse</em> of the above. That is, we need a function that, provided a quantile value <img src="https://latex.codecogs.com/png.latex?%5Ctau">, returns the outcome value that maps to that quantile in the distribution. This is fundamentally what we’ll be working with to estimate treatment effects because we want to know what the effect of the program is at the 75th percentile, not for someone with $2,000 in earnings.</p>
<p>The concept described above is known as the <strong>inverse distribution function</strong>, and in our notation will be defined as <img src="https://latex.codecogs.com/png.latex?F%5E%7B-1%7D_%7BY(W)wt%7D(%5Ctau)">. That is, we supply this function with a quantile <img src="https://latex.codecogs.com/png.latex?%5Ctau">, and it returns the value associated with the outcome distribution at that particular quantile.</p>
<p>From a practical sense, calculating the inverse CDF in R is straightforward, however there is not a base function like <code>ecdf()</code> we can draw from. Fortunately, the package <code>edfun</code> provides us with an easy way to calculate it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1">invF11 <span class="ot" style="color: #003B4F;">&lt;-</span> edfun<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">edfun</span>(y11)<span class="sc" style="color: #5E5E5E;">$</span>qfun</span>
<span id="cb8-2">invF01 <span class="ot" style="color: #003B4F;">&lt;-</span> edfun<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">edfun</span>(y01)<span class="sc" style="color: #5E5E5E;">$</span>qfun</span>
<span id="cb8-3"></span>
<span id="cb8-4"><span class="fu" style="color: #4758AB;">invF11</span>(<span class="fl" style="color: #AD0000;">0.75</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 9631.9</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><span class="fu" style="color: #4758AB;">invF01</span>(<span class="fl" style="color: #AD0000;">0.75</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 7284.4</code></pre>
</div>
</div>
<p>In the calculated values above, an earnings value of 9632 would place you at the 75th percentile of the treated group’s post-intervention outcome distribution. Similarly, an earnings value of 7284 would place you at the 75th percentile of the untreated group’s post-intervention outcome distribution.</p>
<p>We’re now ready to estimate quantile treatment effects. Formally, the <strong>quantile treatment effect on the treated (QTT)</strong> at <img src="https://latex.codecogs.com/png.latex?%5Ctau"> is obtained as the difference in the inverse distribution function for the treated group in the post period under treatment and under non-treatment:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5CDelta_%7B%5Ctau%7D%20=%20F%5E%7B-1%7D_%7BY(1)11%7D(%5Ctau)%20-%20F%5E%7B-1%7D_%7BY(0)11%7D(%5Ctau)%0A"></p>
<p>However, as usual the second quantity is an unobserved counterfactual. Given random assignment, we can estimate QTTs using the inverse distribution function from the untreated group.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5CDelta_%7B%5Ctau%7D%20=%20F%5E%7B-1%7D_%7BY(1)11%7D(%5Ctau)%20-%20F%5E%7B-1%7D_%7BY(0)01%7D(%5Ctau)%0A"></p>
<p>So what is QTT(0.75) in the Lalonde experimental data?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><span class="fu" style="color: #4758AB;">invF11</span>(<span class="fl" style="color: #AD0000;">0.75</span>) <span class="sc" style="color: #5E5E5E;">-</span> <span class="fu" style="color: #4758AB;">invF01</span>(<span class="fl" style="color: #AD0000;">0.75</span>)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2347.5</code></pre>
</div>
</div>
<p>There it is; we’ve calculated a quantile treatment effect in our experimental data!</p>
<p>In practice we do not need to go through the above process by hand each time. We can actually just plug our data into the <code>qte</code> package’s functions to obtain estimates and standard errors:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1">att_experimental <span class="ot" style="color: #003B4F;">&lt;-</span> </span>
<span id="cb14-2">  <span class="fu" style="color: #4758AB;">ci.qtet</span>(re78 <span class="sc" style="color: #5E5E5E;">~</span> treat, </span>
<span id="cb14-3">    <span class="at" style="color: #657422;">data=</span>lalonde.exp, </span>
<span id="cb14-4">    <span class="at" style="color: #657422;">probs=</span><span class="fu" style="color: #4758AB;">c</span>(<span class="fl" style="color: #AD0000;">0.25</span>, <span class="fl" style="color: #AD0000;">0.5</span>, <span class="fl" style="color: #AD0000;">0.75</span>), </span>
<span id="cb14-5">    <span class="at" style="color: #657422;">se=</span>T, </span>
<span id="cb14-6">    <span class="at" style="color: #657422;">iters=</span><span class="dv" style="color: #AD0000;">10</span>)</span>
<span id="cb14-7">res_att_experimental <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">summary</span>(att_experimental)</span></code></pre></div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>Note that the <code>qte</code> package computes standard errors via a bootstrap method.</p>
</div></div><p>You’ll see in Figure&nbsp;3 that the estimated QTT for the 75th percentile is exactly the same as we calculated above.</p>
<div class="cell">
<div id="fig-qte-exp" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">

<table class="table" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
Percentile
</th>
<th style="text-align:right;">
Treatment Effect
</th>
<th style="text-align:right;">
Standard Error
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Avg
</td>
<td style="text-align:right;">
1794.3
</td>
<td style="text-align:right;">
504.7
</td>
</tr>
<tr>
<td style="text-align:left;">
75%
</td>
<td style="text-align:right;">
2347.5
</td>
<td style="text-align:right;">
736.6
</td>
</tr>
<tr>
<td style="text-align:left;">
50%
</td>
<td style="text-align:right;">
1123.5
</td>
<td style="text-align:right;">
824.2
</td>
</tr>
<tr>
<td style="text-align:left;">
25%
</td>
<td style="text-align:right;">
338.6
</td>
<td style="text-align:right;">
231.2
</td>
</tr>
</tbody>

</table>
<p></p><figcaption class="figure-caption">Figure 3: Average and Quantile Treatment Effects for the Experimental Lalonde Data</figcaption><p></p>
</figure>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-ggqte-exp" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://graveja0.github.io/HPOL8539-F2022/blog/posts/quantile-treatment-effects_files/figure-html/fig-ggqte-exp-1.png" class="img-fluid figure-img" width="672"></p>
<p></p><figcaption class="figure-caption">Figure 4: Plot of Quantile Treatment Effects as Estimated Using qte Package</figcaption><p></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="quantile-treatment-effect-estimation-in-observational-data" class="level2 page-columns page-full">
<h2 class="anchored" data-anchor-id="quantile-treatment-effect-estimation-in-observational-data">Quantile Treatment Effect Estimation in Observational Data</h2>
<p>Now suppose we do not have the luxury of experimental data, but instead have a treated group and untreated group drawn from observational data. How can we identify and estimate quantile treatment effects?</p>
<p>There are a number of approaches we can take here:</p>
<ol type="1">
<li>Estimate bounds on the quantile treatment effect distribution.</li>
<li>Estimate QTTs under an assumption of conditional independence, i.e., unconfoudnendess.</li>
<li>Estimate QTTs using a quantile difference-in-differences (qDID) estimator.</li>
<li>Estimate QTTs using a changes-in-changes (CiC) estimator (Athey and Imbens 2006).</li>
</ol>
<p>Partial identification via estimating bounds (#1) will be a focus of our class next week, so we’ll set it aside for now – though note that the <code>qte</code> package can estimate bounds based on the method in Fan and Yu (2012).</p>
<p>Similarly, if we think we have enough measured data satisfy an unconfoundedness assumption (analogous to what we do with propensity scores ore matching) we can also estimate (#2) using the <code>qte</code> package.</p>
<p>Our focus for today will be on approaches (#3) and especially (#4). We’ll also discuss how we can incorporate covariates to improve identifcation of quantile treatment effects.</p>
<section id="intuition-for-qdid-and-cic" class="level3">
<h3 class="anchored" data-anchor-id="intuition-for-qdid-and-cic">Intuition for qDID and CiC</h3>
<p>Essentially, we’re going to lean on similar intuition for identifying QTTs as we do for identifying average treatment effects on the treated using difference-in-differences. In the case of quantile effects, however, we will be thinking in terms of how the distribution functions change in an untreated comparison group. We’ll then use these changes as a “stand-in” for the counterfactual change that would have occurred in the treated group absent the treatment.</p>
<p>The difference between qDID and CiC essentially boils down to how we think about the counterfactual. Let’s envision two scenarios with observational data for a job training program under which the treatment group is selected predominantly among unemployed individuals with low earnings:</p>
<ol type="1">
<li><p>The pre-intervention earnings at the 50th percentile in the treatment group are $0, and at the 50th percentile of the untreated group, pre-intervention earnings are $5,000. In the post-intervention period, the untreated group’s earnings increase to $6,000 at the 50th percentile, while the treated group’s earnings rise to $3000 at the 50th percentile.</p></li>
<li><p>The pre-intervention earnings at the 50th percentile in the treatment group are $0, and $0 in earnings corresponds to the 10th percentile of the untreated group’s pre-intervention earnings distribution. In the post period, the untreated group’s earnings remain at $0 at the 10th percentile, while earnings at the 50th percentile in the treated group rise to $3,000.</p></li>
</ol>
<p>What counterfactual should we use for the treated group? The $1,000 rise in earnings observed at the 50th percentile in the untreated group, even though the baseline value at the 50th percentile was very different than the treated group’s median value? Or, is a better estimate of the counterfactual the experience of $0 earners at the 10th percentile in the untreated group? <strong>In short, the former assumption is used for qDID, while the latter assumption is used for CiC.</strong></p>
</section>
<section id="estimating-qdid-and-cic" class="level3 page-columns page-full">
<h3 class="anchored" data-anchor-id="estimating-qdid-and-cic">Estimating qDID and CiC</h3>
<p>With the intuition for both approaches solidified, let’s now construct quantile treatment effect estimates in the observational Lalonde data using each.</p>
<p>First, let’s pull out the outcome values for treated and control groups in the pre (1975) and post-intervention (1978) periods:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">y00 <span class="ot" style="color: #003B4F;">&lt;-</span> lalonde.psid <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb15-2">  <span class="fu" style="color: #4758AB;">filter</span>(treat<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">0</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb15-3">  <span class="fu" style="color: #4758AB;">pull</span>(re75)</span>
<span id="cb15-4"></span>
<span id="cb15-5">y10 <span class="ot" style="color: #003B4F;">&lt;-</span> lalonde.psid <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb15-6">  <span class="fu" style="color: #4758AB;">filter</span>(treat<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb15-7">  <span class="fu" style="color: #4758AB;">pull</span>(re75)</span>
<span id="cb15-8"></span>
<span id="cb15-9">y01 <span class="ot" style="color: #003B4F;">&lt;-</span> lalonde.psid <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb15-10">  <span class="fu" style="color: #4758AB;">filter</span>(treat<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">0</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb15-11">  <span class="fu" style="color: #4758AB;">pull</span>(re78)</span>
<span id="cb15-12"></span>
<span id="cb15-13">y11 <span class="ot" style="color: #003B4F;">&lt;-</span> lalonde.psid <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb15-14">  <span class="fu" style="color: #4758AB;">filter</span>(treat<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb15-15">  <span class="fu" style="color: #4758AB;">pull</span>(re78)</span></code></pre></div>
</div>
<p>We’ll next define eCDFs and inverse eCDFs for each:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1">eF00 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">ecdf</span>(y00)</span>
<span id="cb16-2">invF00 <span class="ot" style="color: #003B4F;">&lt;-</span> edfun<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">edfun</span>(y00)<span class="sc" style="color: #5E5E5E;">$</span>qfun</span>
<span id="cb16-3"></span>
<span id="cb16-4">eF10 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">ecdf</span>(y10)</span>
<span id="cb16-5">invF10 <span class="ot" style="color: #003B4F;">&lt;-</span> edfun<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">edfun</span>(y10)<span class="sc" style="color: #5E5E5E;">$</span>qfun</span>
<span id="cb16-6"></span>
<span id="cb16-7">eF01 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">ecdf</span>(y01)</span>
<span id="cb16-8">invF01 <span class="ot" style="color: #003B4F;">&lt;-</span> edfun<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">edfun</span>(y01)<span class="sc" style="color: #5E5E5E;">$</span>qfun</span>
<span id="cb16-9"></span>
<span id="cb16-10">eF11 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">ecdf</span>(y11)</span>
<span id="cb16-11">invF11 <span class="ot" style="color: #003B4F;">&lt;-</span> edfun<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">edfun</span>(y11)<span class="sc" style="color: #5E5E5E;">$</span>qfun</span></code></pre></div>
</div>
<p>The next thing we need to do is to define a quantile of interest. Let’s estimate for the 75th percentile.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1">q <span class="ot" style="color: #003B4F;">=</span> <span class="fl" style="color: #AD0000;">0.75</span></span></code></pre></div>
</div>
<p>Next, let’s estimate the observed change in the treated group at the 75th percentile:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><span class="fu" style="color: #4758AB;">invF11</span>(q)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 9631.9</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><span class="fu" style="color: #4758AB;">invF10</span>(q)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1809</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1">change_treated <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">invF11</span>(q) <span class="sc" style="color: #5E5E5E;">-</span> <span class="fu" style="color: #4758AB;">invF10</span>(q)</span>
<span id="cb22-2">change_treated</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 7822.9</code></pre>
</div>
</div>
<p>So we observe earnings going up by 7823. But what would have happened counterfactually? For this we will appeal to the untreated group’s experience.</p>
<p>First, let’s estimate what change happens at the 75th percentile of the untreated group’s earnings distribution:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><span class="fu" style="color: #4758AB;">invF01</span>(q)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 29510</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><span class="fu" style="color: #4758AB;">invF00</span>(q)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 26470</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1">cfx_untreated_q75 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">invF01</span>(q) <span class="sc" style="color: #5E5E5E;">-</span> <span class="fu" style="color: #4758AB;">invF00</span>(q)</span>
<span id="cb28-2">cfx_untreated_q75 </span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3040.2</code></pre>
</div>
</div>
<p>To construct a qDID estimate, we’d simply net out this counterfactual from the observed change in the treated group:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1">qtt_qDID <span class="ot" style="color: #003B4F;">&lt;-</span> change_treated <span class="sc" style="color: #5E5E5E;">-</span> cfx_untreated_q75 </span>
<span id="cb30-2">qtt_qDID </span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4782.7</code></pre>
</div>
</div>
<p>Using qDID, we would estimate that the job trainings program increased earnings by $4783.</p>
<p>Notice, however, that there is a <em>huge</em> difference in earnings at the 75th percentile of the treated group’s pre-intervention earnings distribution ($1809), and the untreated group’s ($26470).</p>
<p>As an alternative, we can adopt a Changes-in-Changes model. Recall from above that this model requires an additional step: we must map the earnings value of the treated group at the 75th percentile to the corresponding quantile in the untreated groups pre-intervention earnings distribution. We then use the change in earnings <em>at this different quantile</em> as an estimate of the counterfactual:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><span class="co" style="color: #5E5E5E;"># Earnings at the qth quantile of the treated group</span></span>
<span id="cb32-2">y_q <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">invF10</span>(q)</span>
<span id="cb32-3">y_q</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 1809</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><span class="co" style="color: #5E5E5E;"># Find what quantile this maps to in the untreated group's distribution. </span></span>
<span id="cb34-2">q_star <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">eF00</span>(y_q)</span>
<span id="cb34-3">q_star</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.11365</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1">cfx_CiC <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">invF01</span>(q_star) <span class="sc" style="color: #5E5E5E;">-</span> y_q</span>
<span id="cb36-2">cfx_CiC</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -1809</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1">change_treated <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">invF11</span>(q) <span class="sc" style="color: #5E5E5E;">-</span> <span class="fu" style="color: #4758AB;">invF10</span>(q)</span>
<span id="cb38-2">change_treated</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 7822.9</code></pre>
</div>
<div class="sourceCode cell-code" id="cb40" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1">qtt_CiC <span class="ot" style="color: #003B4F;">&lt;-</span> change_treated <span class="sc" style="color: #5E5E5E;">-</span> cfx_CiC</span>
<span id="cb40-2">qtt_CiC</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 9631.9</code></pre>
</div>
</div>
<p>While the above exercises went through estimating a changes-in-changes value by hand, the formal estimator is a bit simpler due to some cancelling out of terms. Specifically, the counterfactual CDF is given by</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Chat%20F_%7BY(0),11%7D(y)%20=%20F_%7By,01%7D(F_%7By,00%7D%5E%7B-1%7D(F_%7By,10%7D(y)))%0A"></p>
<p>where F_{y,00} is the observed CDF for the untreated group in the pre-period, F_{y,10} is the observed CDF for the treated group in the pre period, etc.</p>
<p>Equivalently, we can estimate the inverse CDF of the counterfactual as:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Chat%20F_%7BY(0),11%7D%5E%7B-1%7D(%5Ctau)%20=%20F_%7By,01%7D%5E%7B-1%7D(F_%7By,00%7D(F%5E%7B-1%7D_%7By,10%7D(%5Ctau)))%0A"></p>
<p>And the treatement effect estimate is given by:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5CDelta_%7B%5Ctau%7D%5E%7BCiC%7D%20=%20F_%7BY(1),11%7D%5E%7B-1%7D(%5Ctau)-%20%5Chat%20F_%7BY(0),11%7D%5E%7B-1%7D(%5Ctau)%0A"></p>
<p>Implemented for our example, the QTT for the 75th percentile is</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><span class="fu" style="color: #4758AB;">invF11</span>(q) <span class="sc" style="color: #5E5E5E;">-</span> <span class="fu" style="color: #4758AB;">invF01</span>(<span class="fu" style="color: #4758AB;">eF00</span>(<span class="fu" style="color: #4758AB;">invF10</span>(q)))</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 9631.9</code></pre>
</div>
</div>
<p>which is identical to the “by hand” estimate we calculated above.</p>
<p>Again, the <code>qte</code> package in R will calculate changes-in-changes estimates for you, along with standard errors. The estimates are slightly different here, owing to some “lumpiness” in the eCDFs and slight differnces in calculating the values at quantiles in the data. However, the QTTs are quite close to what we estimated above:<br>
</p>

<div class="no-row-height column-margin column-container"><div class="">
<p>There is also a Stata implementation of the Changes-in-Changes estimator, which can be found <a href="https://sites.google.com/site/blaisemelly/home/computer-programs/cic_stata">here</a>.</p>
</div></div><div class="cell">
<div class="sourceCode cell-code" id="cb44" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1">df <span class="ot" style="color: #003B4F;">&lt;-</span> </span>
<span id="cb44-2">  lalonde.psid <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb44-3">  <span class="fu" style="color: #4758AB;">select</span>(id,re75,re78,treat) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb44-4">  <span class="fu" style="color: #4758AB;">gather</span>(year,y,<span class="sc" style="color: #5E5E5E;">-</span>id,<span class="sc" style="color: #5E5E5E;">-</span>treat) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb44-5">  <span class="fu" style="color: #4758AB;">tibble</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb44-6">  <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">year =</span> <span class="fu" style="color: #4758AB;">ifelse</span>(year<span class="sc" style="color: #5E5E5E;">==</span><span class="st" style="color: #20794D;">"re75"</span>,<span class="dv" style="color: #AD0000;">1975</span>,<span class="dv" style="color: #AD0000;">1978</span>))</span>
<span id="cb44-7"></span>
<span id="cb44-8">est_CiC <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">CiC</span>(y <span class="sc" style="color: #5E5E5E;">~</span> treat, <span class="at" style="color: #657422;">t =</span> <span class="dv" style="color: #AD0000;">1978</span>, <span class="at" style="color: #657422;">tmin1=</span><span class="dv" style="color: #AD0000;">1975</span>, </span>
<span id="cb44-9">               <span class="at" style="color: #657422;">tname =</span> <span class="st" style="color: #20794D;">"year"</span>, <span class="at" style="color: #657422;">idname =</span> <span class="st" style="color: #20794D;">"id"</span>,</span>
<span id="cb44-10">               <span class="at" style="color: #657422;">data =</span> df, <span class="at" style="color: #657422;">probs =</span> <span class="fu" style="color: #4758AB;">c</span>(q), </span>
<span id="cb44-11">               <span class="at" style="color: #657422;">se =</span> <span class="cn" style="color: #8f5902;">TRUE</span>, <span class="at" style="color: #657422;">panel =</span> F)</span>
<span id="cb44-12"><span class="fu" style="color: #4758AB;">summary</span>(est_CiC)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Quantile Treatment Effect:
        
tau QTE Std. Error
0.75    9643.00 1030.48

Average Treatment Effect:   5089.64
     Std. Error:        685.15</code></pre>
</div>
</div>
</section>
</section>
</section>
<section id="changes-in-changes-with-covariates" class="level1">
<h1>Changes-in-Changes with Covariates</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb46" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><span class="co" style="color: #5E5E5E;"># Note that this code is simply adapted from the underlying CiC formula to show </span></span>
<span id="cb46-2"><span class="co" style="color: #5E5E5E;"># what is going on behind the curtain. Code source: Calloway's qte package. </span></span>
<span id="cb46-3"></span>
<span id="cb46-4"><span class="fu" style="color: #4758AB;">library</span>(quantreg)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: SparseM</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'SparseM'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:base':

    backsolve</code></pre>
</div>
<div class="sourceCode cell-code" id="cb50" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><span class="co" style="color: #5E5E5E;"># Quantiles to estimate over</span></span>
<span id="cb50-2">u <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">seq</span>(<span class="fl" style="color: #AD0000;">0.01</span>, <span class="fl" style="color: #AD0000;">0.99</span>, <span class="fl" style="color: #AD0000;">0.01</span>)</span>
<span id="cb50-3"></span>
<span id="cb50-4"><span class="co" style="color: #5E5E5E;"># Extract out various subsets of the data based on treatment and time </span></span>
<span id="cb50-5">df00 <span class="ot" style="color: #003B4F;">=</span> lalonde.psid.panel <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb50-6">  <span class="fu" style="color: #4758AB;">filter</span>(treat<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">0</span> <span class="sc" style="color: #5E5E5E;">&amp;</span> year<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1975</span>)</span>
<span id="cb50-7"></span>
<span id="cb50-8">df10 <span class="ot" style="color: #003B4F;">=</span> lalonde.psid.panel <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb50-9">  <span class="fu" style="color: #4758AB;">filter</span>(treat<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1</span> <span class="sc" style="color: #5E5E5E;">&amp;</span> year<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1975</span>)</span>
<span id="cb50-10"></span>
<span id="cb50-11">df01 <span class="ot" style="color: #003B4F;">=</span> lalonde.psid.panel <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb50-12">  <span class="fu" style="color: #4758AB;">filter</span>(treat<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">0</span> <span class="sc" style="color: #5E5E5E;">&amp;</span> year<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1978</span>)</span>
<span id="cb50-13"></span>
<span id="cb50-14">df11 <span class="ot" style="color: #003B4F;">=</span> lalonde.psid.panel <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb50-15">  <span class="fu" style="color: #4758AB;">filter</span>(treat<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1</span> <span class="sc" style="color: #5E5E5E;">&amp;</span> year<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1978</span>)</span>
<span id="cb50-16"></span>
<span id="cb50-17"><span class="co" style="color: #5E5E5E;"># Obtain sample sizes for each subset</span></span>
<span id="cb50-18">n1t <span class="ot" style="color: #003B4F;">&lt;-</span> df11  <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb50-19">  <span class="fu" style="color: #4758AB;">nrow</span>()</span>
<span id="cb50-20">n1tmin1 <span class="ot" style="color: #003B4F;">&lt;-</span>df10  <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb50-21">  <span class="fu" style="color: #4758AB;">nrow</span>()</span>
<span id="cb50-22">n0t <span class="ot" style="color: #003B4F;">&lt;-</span> df01 <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb50-23">  <span class="fu" style="color: #4758AB;">nrow</span>()</span>
<span id="cb50-24">n0tmin1 <span class="ot" style="color: #003B4F;">&lt;-</span> df00 <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb50-25">  <span class="fu" style="color: #4758AB;">nrow</span>()</span>
<span id="cb50-26"></span>
<span id="cb50-27"><span class="co" style="color: #5E5E5E;"># Quantile regressions of the outcome on covariates</span></span>
<span id="cb50-28">yformla <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="st" style="color: #20794D;">"re ~ age + I(age^2) + education + black + hispanic + married + nodegree"</span></span>
<span id="cb50-29">QR0t <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rq</span>(yformla, <span class="at" style="color: #657422;">data =</span> df01 , <span class="at" style="color: #657422;">tau =</span> u)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in rq.fit.br(x, y, tau = tau, ...): Solution may be nonunique</code></pre>
</div>
<div class="sourceCode cell-code" id="cb52" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1">QR0tmin1 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rq</span>(yformla, <span class="at" style="color: #657422;">data =</span> df00, <span class="at" style="color: #657422;">tau =</span> u)</span>
<span id="cb52-2">QR1t <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">rq</span>(yformla, <span class="at" style="color: #657422;">data =</span> df11, <span class="at" style="color: #657422;">tau =</span> u)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in rq.fit.br(x, y, tau = tau, ...): Solution may be nonunique

Warning in rq.fit.br(x, y, tau = tau, ...): Solution may be nonunique</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><span class="co" style="color: #5E5E5E;"># Obtain predictions of the conditional distribution function given each </span></span>
<span id="cb54-2"><span class="co" style="color: #5E5E5E;"># sample individual's covariate </span></span>
<span id="cb54-3"><span class="co" style="color: #5E5E5E;"># This is for the pre-period in the control group </span></span>
<span id="cb54-4">QR0tmin1F <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">predict</span>(QR0tmin1, <span class="at" style="color: #657422;">newdata =</span> df10,</span>
<span id="cb54-5">                     <span class="at" style="color: #657422;">type =</span> <span class="st" style="color: #20794D;">"Fhat"</span>, <span class="at" style="color: #657422;">stepfun =</span> <span class="cn" style="color: #8f5902;">TRUE</span>)</span>
<span id="cb54-6"><span class="co" style="color: #5E5E5E;"># Now map the observed outcome into the quantile of the conditional distribution function </span></span>
<span id="cb54-7"><span class="co" style="color: #5E5E5E;"># for each sample individual</span></span>
<span id="cb54-8">F0tmin1 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">sapply</span>(<span class="dv" style="color: #AD0000;">1</span><span class="sc" style="color: #5E5E5E;">:</span>n1tmin1, <span class="cf" style="color: #003B4F;">function</span>(i) QR0tmin1F[[i]](df10<span class="sc" style="color: #5E5E5E;">$</span>re[i]))</span>
<span id="cb54-9"></span>
<span id="cb54-10">QR0tQ <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">predict</span>(QR0t, <span class="at" style="color: #657422;">newdata =</span> df10, <span class="at" style="color: #657422;">type =</span> <span class="st" style="color: #20794D;">"Qhat"</span>,</span>
<span id="cb54-11">                 <span class="at" style="color: #657422;">stepfun =</span> <span class="cn" style="color: #8f5902;">TRUE</span>)</span>
<span id="cb54-12">y0t <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">sapply</span>(<span class="dv" style="color: #AD0000;">1</span><span class="sc" style="color: #5E5E5E;">:</span>n1tmin1, <span class="cf" style="color: #003B4F;">function</span>(i) QR0tQ[[i]](F0tmin1[i]))</span>
<span id="cb54-13">F.treatedcf.t <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">ecdf</span>(y0t)</span>
<span id="cb54-14">att <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">mean</span>(df11[, <span class="st" style="color: #20794D;">"re"</span>]) <span class="sc" style="color: #5E5E5E;">-</span> <span class="fu" style="color: #4758AB;">mean</span>(y0t)</span>
<span id="cb54-15"></span>
<span id="cb54-16">q1 <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">quantile</span>(df11[, <span class="st" style="color: #20794D;">"re"</span>], <span class="at" style="color: #657422;">probs =</span> u, <span class="at" style="color: #657422;">type =</span> <span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb54-17">q0 <span class="ot" style="color: #003B4F;">=</span> <span class="fu" style="color: #4758AB;">quantile</span>(F.treatedcf.t, <span class="at" style="color: #657422;">probs =</span> u, <span class="at" style="color: #657422;">type =</span> <span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb54-18">qte <span class="ot" style="color: #003B4F;">=</span> (q1 <span class="sc" style="color: #5E5E5E;">-</span> q0); qte</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      1%       2%       3%       4%       5%       6%       7%       8% 
    0.00     0.00     0.00     0.00     0.00     0.00     0.00     0.00 
      9%      10%      11%      12%      13%      14%      15%      16% 
    0.00     0.00     0.00     0.00     0.00     0.00     0.00     0.00 
     17%      18%      19%      20%      21%      22%      23%      24% 
    0.00     0.00     0.00     0.00     0.00     0.00     0.00     0.00 
     25%      26%      27%      28%      29%      30%      31%      32% 
  485.23   559.44   590.78   671.33   743.67   929.88  1048.43  1085.44 
     33%      34%      35%      36%      37%      38%      39%      40% 
 1294.41  1358.64  1460.36  1652.64  1773.42  1953.27  2164.02  2321.11 
     41%      42%      43%      44%      45%      46%      47%      48% 
 2456.15  2787.96  3094.16  3196.57  3462.56  3786.63  3881.28  4032.71 
     49%      50%      51%      52%      53%      54%      55%      56% 
 4146.60  4232.31  4321.71  4666.24  4843.18  4849.56  5010.34  5149.50 
     57%      58%      59%      60%      61%      62%      63%      64% 
 5522.79  5615.19  6167.68  6181.88  6281.43  6456.70  6788.46  7284.99 
     65%      66%      67%      68%      69%      70%      71%      72% 
 7458.11  7506.15  7535.94  8048.60  7461.02  7508.97  7746.03  7953.09 
     73%      74%      75%      76%      77%      78%      79%      80% 
 8138.60  8211.33  8210.84  8347.53  8189.37  7911.28  8298.11  8332.69 
     81%      82%      83%      84%      85%      86%      87%      88% 
 8164.24  8030.49  7746.49  8426.08  8515.98  8293.94  8147.08  8148.86 
     89%      90%      91%      92%      93%      94%      95%      96% 
 8307.59  8822.00  9450.88  9370.33  9691.94  9955.40  8273.74 11024.51 
     97%      98%      99% 
10944.14 12467.26 17466.10 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb56" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1">c1 <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">CiC</span>(re <span class="sc" style="color: #5E5E5E;">~</span> treat, <span class="at" style="color: #657422;">t=</span><span class="dv" style="color: #AD0000;">1978</span>, <span class="at" style="color: #657422;">tmin1=</span><span class="dv" style="color: #AD0000;">1975</span>, <span class="at" style="color: #657422;">tname=</span><span class="st" style="color: #20794D;">"year"</span>,</span>
<span id="cb56-2">          <span class="at" style="color: #657422;">xformla=</span><span class="sc" style="color: #5E5E5E;">~</span>age <span class="sc" style="color: #5E5E5E;">+</span> <span class="fu" style="color: #4758AB;">I</span>(age<span class="sc" style="color: #5E5E5E;">^</span><span class="dv" style="color: #AD0000;">2</span>) <span class="sc" style="color: #5E5E5E;">+</span> education <span class="sc" style="color: #5E5E5E;">+</span> black <span class="sc" style="color: #5E5E5E;">+</span> hispanic <span class="sc" style="color: #5E5E5E;">+</span> married <span class="sc" style="color: #5E5E5E;">+</span> nodegree,</span>
<span id="cb56-3">          <span class="at" style="color: #657422;">data=</span>lalonde.psid.panel, <span class="at" style="color: #657422;">idname=</span><span class="st" style="color: #20794D;">"id"</span>, <span class="at" style="color: #657422;">se=</span><span class="cn" style="color: #8f5902;">FALSE</span>,</span>
<span id="cb56-4">          <span class="at" style="color: #657422;">probs=</span><span class="fu" style="color: #4758AB;">seq</span>(<span class="fl" style="color: #AD0000;">0.05</span>, <span class="fl" style="color: #AD0000;">0.95</span>, <span class="fl" style="color: #AD0000;">0.05</span>))</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in rq.fit.br(x, y, tau = tau, ...): Solution may be nonunique

Warning in rq.fit.br(x, y, tau = tau, ...): Solution may be nonunique

Warning in rq.fit.br(x, y, tau = tau, ...): Solution may be nonunique</code></pre>
</div>
<div class="sourceCode cell-code" id="cb58" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><span class="fu" style="color: #4758AB;">summary</span>(c1)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Quantile Treatment Effect:
        
tau QTE
0.05       0.00
0.1    0.00
0.15       0.00
0.2    0.00
0.25     485.23
0.3  929.88
0.35    1460.36
0.4 2321.11
0.45    3462.56
0.5 4232.31
0.55    5010.34
0.6 6210.67
0.65    7458.11
0.7 7508.97
0.75    8210.84
0.8 8332.69
0.85    8515.98
0.9 8822.00
0.95    8273.74

Average Treatment Effect:   4629.24</code></pre>
</div>
</div>


</section>

 ]]></description>
  <guid>https://graveja0.github.io/HPOL8539-F2022/blog/posts/quantile-treatment-effects.html</guid>
  <pubDate>Wed, 09 Nov 2022 11:57:11 GMT</pubDate>
</item>
<item>
  <title>Fourteen Difference-in-Difference Estimators Walk Into a Bar …</title>
  <link>https://graveja0.github.io/HPOL8539-F2022/blog/posts/a-comparison-of-difference-in-difference-estimators.html</link>
  <description><![CDATA[ 



<section id="introduction" class="level1">
<h1>Introduction</h1>
</section>
<section id="setup" class="level1">
<h1>Setup</h1>
<div class="cell">

</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;">set.seed</span>(<span class="dv" style="color: #AD0000;">23</span>)</span>
<span id="cb1-2">sim6b <span class="ot" style="color: #003B4F;">&lt;-</span> params6b <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">make_data</span>(<span class="at" style="color: #657422;">N =</span> <span class="dv" style="color: #AD0000;">500</span>, <span class="at" style="color: #657422;">start =</span> <span class="dv" style="color: #AD0000;">2008</span>, <span class="at" style="color: #657422;">stop =</span> <span class="dv" style="color: #AD0000;">2022</span>, <span class="at" style="color: #657422;">rho_t=</span><span class="fl" style="color: #AD0000;">0.8</span>) </span>
<span id="cb1-3">sim6b <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">plot_data</span>()</span>
<span id="cb1-4">df_sim6b <span class="ot" style="color: #003B4F;">&lt;-</span> sim6b <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">pluck</span>(<span class="st" style="color: #20794D;">"df"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">prepare</span>()</span>
<span id="cb1-5">sim6b_truth <span class="ot" style="color: #003B4F;">&lt;-</span> sim6b<span class="sc" style="color: #5E5E5E;">$</span>truth</span>
<span id="cb1-6">sim6b_desc <span class="ot" style="color: #003B4F;">&lt;-</span> sim6b<span class="sc" style="color: #5E5E5E;">$</span>params<span class="sc" style="color: #5E5E5E;">$</span>desc</span>
<span id="cb1-7">sim6b_est <span class="ot" style="color: #003B4F;">&lt;-</span> df_sim6b <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">estimate</span>()</span>
<span id="cb1-8">sim6b_res <span class="ot" style="color: #003B4F;">&lt;-</span> sim6b_est <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">discriminate</span>(<span class="at" style="color: #657422;">truth =</span> sim6b<span class="sc" style="color: #5E5E5E;">$</span>truth)</span>
<span id="cb1-9"><span class="fu" style="color: #4758AB;">plan</span>(multisession,<span class="at" style="color: #657422;">workers=</span>parallel<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">detectCores</span>()<span class="sc" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb1-10">res6b <span class="ot" style="color: #003B4F;">&lt;-</span></span>
<span id="cb1-11">  <span class="fu" style="color: #4758AB;">with_progress</span>({</span>
<span id="cb1-12">    <span class="fu" style="color: #4758AB;">gen_est_disc</span>(<span class="dv" style="color: #AD0000;">1</span><span class="sc" style="color: #5E5E5E;">:</span><span class="dv" style="color: #AD0000;">100</span>, <span class="at" style="color: #657422;">params =</span> params6b, <span class="at" style="color: #657422;">start =</span> <span class="dv" style="color: #AD0000;">2008</span>, <span class="at" style="color: #657422;">stop =</span> <span class="dv" style="color: #AD0000;">2022</span>, <span class="at" style="color: #657422;">rho_t =</span> <span class="fl" style="color: #AD0000;">0.8</span>, <span class="at" style="color: #657422;">N =</span> <span class="dv" style="color: #AD0000;">500</span>)</span>
<span id="cb1-13"></span>
<span id="cb1-14">  })</span>
<span id="cb1-15"></span>
<span id="cb1-16"></span>
<span id="cb1-17">p_df6b <span class="ot" style="color: #003B4F;">&lt;-</span></span>
<span id="cb1-18">  res6b <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb1-19">  <span class="fu" style="color: #4758AB;">bind_rows</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb1-20">  <span class="fu" style="color: #4758AB;">group_by</span>(rel_time) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb1-21">  <span class="fu" style="color: #4758AB;">summarise_all</span>(mean) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb1-22">  <span class="fu" style="color: #4758AB;">gather</span>(estimator,estimate,<span class="sc" style="color: #5E5E5E;">-</span>rel_time) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb1-23">  <span class="fu" style="color: #4758AB;">filter</span>(estimator<span class="sc" style="color: #5E5E5E;">!=</span><span class="st" style="color: #20794D;">"truth"</span>)</span>
<span id="cb1-24"></span>
<span id="cb1-25">ests <span class="ot" style="color: #003B4F;">&lt;-</span> p_df6b<span class="sc" style="color: #5E5E5E;">$</span>estimator <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">unique</span>()</span>
<span id="cb1-26"></span>
<span id="cb1-27">p_df6b_ <span class="ot" style="color: #003B4F;">&lt;-</span></span>
<span id="cb1-28">  ests <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb1-29">    <span class="fu" style="color: #4758AB;">map_df</span>(<span class="sc" style="color: #5E5E5E;">~</span>({</span>
<span id="cb1-30">      res6b[[<span class="dv" style="color: #AD0000;">1</span>]] <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb1-31">        <span class="fu" style="color: #4758AB;">select</span>(rel_time,truth) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb1-32">        <span class="fu" style="color: #4758AB;">gather</span>(estimator,estimate,<span class="sc" style="color: #5E5E5E;">-</span>rel_time) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb1-33">        <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">estimator_p =</span> estimator) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb1-34">        <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">estimator=</span>.x)</span>
<span id="cb1-35">    }))</span>
<span id="cb1-36"></span>
<span id="cb1-37"></span>
<span id="cb1-38"></span>
<span id="cb1-39">p_df6b <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">estimator =</span> ests_lut[estimator]) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb1-40">  <span class="fu" style="color: #4758AB;">ggplot</span>(<span class="fu" style="color: #4758AB;">aes</span>(<span class="at" style="color: #657422;">x =</span> rel_time, <span class="at" style="color: #657422;">y =</span> estimate)) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb1-41">  <span class="fu" style="color: #4758AB;">geom_point</span>() <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb1-42">  <span class="fu" style="color: #4758AB;">geom_line</span>() <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb1-43">  <span class="fu" style="color: #4758AB;">geom_line</span>(<span class="at" style="color: #657422;">data =</span> p_df6b_ <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">estimator =</span> ests_lut[estimator]), <span class="at" style="color: #657422;">colour =</span> <span class="st" style="color: #20794D;">"red"</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb1-44">  hrbrthemes<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">theme_ipsum</span>() <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb1-45">  <span class="co" style="color: #5E5E5E;">#ggsci::scale_color_aaas()+</span></span>
<span id="cb1-46">  <span class="co" style="color: #5E5E5E;">#scale_y_continuous(limits = c(0,5.5)) +</span></span>
<span id="cb1-47">  <span class="co" style="color: #5E5E5E;">#scale_x_continuous(expand=c(0.25,0), breaks = seq(0,10,1)) +</span></span>
<span id="cb1-48">  <span class="co" style="color: #5E5E5E;">#geom_dl(method = list("last.bumpup"),aes(label = estimator))+</span></span>
<span id="cb1-49">  <span class="co" style="color: #5E5E5E;">#geom_dl(method = list("first.bumpup"),aes(label = estimator))+</span></span>
<span id="cb1-50">  <span class="fu" style="color: #4758AB;">theme</span>(<span class="at" style="color: #657422;">legend.position=</span><span class="st" style="color: #20794D;">"none"</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb1-51">  <span class="fu" style="color: #4758AB;">facet_wrap</span>(<span class="sc" style="color: #5E5E5E;">~</span>estimator, <span class="at" style="color: #657422;">scales =</span> <span class="st" style="color: #20794D;">"free"</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb1-52">  <span class="fu" style="color: #4758AB;">labs</span>(<span class="at" style="color: #657422;">x =</span> <span class="st" style="color: #20794D;">"Relative Time</span><span class="sc" style="color: #5E5E5E;">\n</span><span class="st" style="color: #20794D;">(Note: Truth is Shown in Red"</span>, <span class="at" style="color: #657422;">y =</span> <span class="st" style="color: #20794D;">"Estimate"</span>) <span class="sc" style="color: #5E5E5E;">+</span></span>
<span id="cb1-53">  <span class="fu" style="color: #4758AB;">ggtitle</span>(<span class="st" style="color: #20794D;">"Staggered Enty</span><span class="sc" style="color: #5E5E5E;">\n</span><span class="st" style="color: #20794D;">Heterogeneous Dynamic Treatment Effects"</span>)</span></code></pre></div>
</div>


</section>

 ]]></description>
  <guid>https://graveja0.github.io/HPOL8539-F2022/blog/posts/a-comparison-of-difference-in-difference-estimators.html</guid>
  <pubDate>Wed, 09 Nov 2022 11:57:11 GMT</pubDate>
</item>
<item>
  <title>Quasi-Demeaning: The Relationship Between Fixed and Random Effects</title>
  <link>https://graveja0.github.io/HPOL8539-F2022/blog/posts/quasi-demeaning.html</link>
  <description><![CDATA[ 



<section id="setup" class="level1">
<h1>Setup</h1>
<p>Assume the following data generation process:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AY_%7Bit%7D%20=%20%5Cmathbf%7BX%7D_%7Bi%7D'%5Cbeta%20+%20%5Ctau%20D_%7Bit%7D%20+%20U_i%20+%5Cepsilon_%7Bit%7D%0A"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?i"> indexes individual units and <img src="https://latex.codecogs.com/png.latex?t"> indexes time, <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BX%7D_i"> are unit-level attributes, <img src="https://latex.codecogs.com/png.latex?D_%7Bit%7D"> is a treatment indicator (set to 1 if the observation is treated and in the post-treatment period). Finally, <img src="https://latex.codecogs.com/png.latex?U_i"> captures unobserved unit-level heterogeneity.</p>
<section id="estimation-random-vs.-fixed-effects" class="level2">
<h2 class="anchored" data-anchor-id="estimation-random-vs.-fixed-effects">Estimation: Random vs.&nbsp;Fixed Effects</h2>
<ul>
<li><p>Random effects uses an approach called “quasi-demeaning” or “partial pooling.”</p></li>
<li><p>The random effects model can be represented as:</p></li>
</ul>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0A(Y_%7Bit%7D-%5Ctheta%20%5Cbar%7BY_i%7D)%20=%20(%5Cmathbf%7BX%7D_%7Bit%7D-%5Ctheta%20%5Cbar%7B%5Cmathbf%7BX%7D_i%7D)'%5Cbeta%20+%20%5Ctau%20(D_%7Bit%7D-%5Ctheta%20%5Cbar%7BD_i%7D)%20%20+%20(%5Cepsilon_%7Bit%7D%20-%20%5Ctheta%20%5Cbar%7B%5Cepsilon_i%7D)%20%5Cquad%20%5Cquad%20%5Cquad%20Eq.%209%0A%5Cend%7Balign%7D%0A"></p>
<p>where</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Ctheta%20=%201%20-%20%5Cbigg%20%5B%5Cfrac%7B%5Csigma%5E2_%5Cepsilon%7D%7B(%5Csigma%5E2_%5Cepsilon%20+%20T%5Csigma%5E2_u)%7D%5Cbigg%20%5D%5E%7B1/2%7D%0A"></p>
<p>In the above, <img src="https://latex.codecogs.com/png.latex?%5Csigma_u"> is the variance of unit-level heterogeneity, and <img src="https://latex.codecogs.com/png.latex?%5Csigma_%7B%5Cepsilon%7D"> is the variance of <img src="https://latex.codecogs.com/png.latex?%5Cepsilon_%7Bit%7D">. And recall <img src="https://latex.codecogs.com/png.latex?T"> is the total number of repeated unit-level observations in our panel (e.g., the total number of time periods, the total number of patients for a given physician, etc.)</p>
<ul>
<li><p>When <img src="https://latex.codecogs.com/png.latex?%5Ctheta%20=%200">, it just reduces pooled regression.</p></li>
<li><p>When <img src="https://latex.codecogs.com/png.latex?%5Ctheta%20=%201">, it is equivalent to fixed effects regression. This <em>only</em> isolates variation within units to estimate the regression coefficients (i.e., units are only compared to themselves, which is why the unobserved heterogeneity is accounted for).</p></li>
<li><p>Essentially, when you fit a random effects regression, Stata estimates <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> and then plugs that estimate it into the above model.</p></li>
<li><p>(When you fit a fixed effects regression, Stata uses the demeaning approach–unless, of course, you manually fit a dummy variable model)</p></li>
<li><p>Often <img src="https://latex.codecogs.com/png.latex?0%20%3C%20%5Ctheta%20%3C%201">, hence the term “partial-pooling.” That is, the regression draws on both variation “within” units and variation “between” units.</p></li>
<li><p>The degree to which within and between variation is used depends on the data context.</p></li>
<li><p>Remember, when <img src="https://latex.codecogs.com/png.latex?%5Ctheta=0"> the random effects regression reduces to pooled OLS. When is this the case?</p>
<ul>
<li>If the term <img src="https://latex.codecogs.com/png.latex?T%5Csigma%5E2_u"> is 0, i.e., <img src="https://latex.codecogs.com/png.latex?%5Csigma%5E2_u=0"> or there is no variation in individual heterogeneity.</li>
</ul></li>
<li><p>Remember, when <img src="https://latex.codecogs.com/png.latex?%5Ctheta=1"> the random effects regression reduces to fixed effects. When is this the case?</p>
<ul>
<li><p>If the term <img src="https://latex.codecogs.com/png.latex?T%5Csigma%5E2_u"> gets super large (more formally, it would need to blast off towards infinity…).</p></li>
<li><p>If we have a very “large” panel of observations on each unit (i.e., large <img src="https://latex.codecogs.com/png.latex?T">) there is sufficient “within” variation and we really don’t need to do any pooling across units.</p></li>
</ul></li>
</ul>
</section>
</section>
<section id="setup-1" class="level1">
<h1>Setup</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><span class="fu" style="color: #4758AB;">library</span>(tidyverse)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching packages ─────────────────────────────────────── tidyverse 1.3.2 ──
✔ ggplot2 3.3.6      ✔ purrr   0.3.5 
✔ tibble  3.1.8      ✔ dplyr   1.0.10
✔ tidyr   1.2.1      ✔ stringr 1.4.1 
✔ readr   2.1.3      ✔ forcats 0.5.2 
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><span class="fu" style="color: #4758AB;">library</span>(lme4)</span></code></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading required package: Matrix

Attaching package: 'Matrix'

The following objects are masked from 'package:tidyr':

    expand, pack, unpack</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><span class="fu" style="color: #4758AB;">library</span>(broom)</span>
<span id="cb5-2"><span class="fu" style="color: #4758AB;">library</span>(knitr)</span>
<span id="cb5-3"><span class="fu" style="color: #4758AB;">theme_set</span>(<span class="fu" style="color: #4758AB;">theme_bw</span>())</span></code></pre></div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1">params_panel <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">list</span>(</span>
<span id="cb6-2">  <span class="at" style="color: #657422;">N =</span> <span class="dv" style="color: #AD0000;">1000</span>,</span>
<span id="cb6-3">  <span class="at" style="color: #657422;">T =</span> <span class="dv" style="color: #AD0000;">2</span>,</span>
<span id="cb6-4">  <span class="at" style="color: #657422;">tx_time =</span> <span class="dv" style="color: #AD0000;">2</span>, </span>
<span id="cb6-5">  <span class="at" style="color: #657422;">rho_t =</span> <span class="fl" style="color: #AD0000;">0.8</span>,</span>
<span id="cb6-6">  <span class="at" style="color: #657422;">beta_0 =</span> <span class="fl" style="color: #AD0000;">0.5</span>,</span>
<span id="cb6-7">  <span class="at" style="color: #657422;">beta_1 =</span> <span class="dv" style="color: #AD0000;">2</span>,</span>
<span id="cb6-8">  <span class="at" style="color: #657422;">tau =</span> <span class="fl" style="color: #AD0000;">0.5</span>,</span>
<span id="cb6-9">  <span class="at" style="color: #657422;">p_d =</span> <span class="fl" style="color: #AD0000;">0.5</span></span>
<span id="cb6-10">)</span>
<span id="cb6-11"></span>
<span id="cb6-12">dgp_panel <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="cf" style="color: #003B4F;">function</span>(params) {</span>
<span id="cb6-13">  <span class="fu" style="color: #4758AB;">with</span>(params, {</span>
<span id="cb6-14"></span>
<span id="cb6-15">    <span class="co" style="color: #5E5E5E;"># Time effects</span></span>
<span id="cb6-16">    t_ <span class="ot" style="color: #003B4F;">&lt;-</span></span>
<span id="cb6-17">      <span class="fu" style="color: #4758AB;">data.frame</span>(<span class="at" style="color: #657422;">t =</span> <span class="dv" style="color: #AD0000;">1</span><span class="sc" style="color: #5E5E5E;">:</span>T,</span>
<span id="cb6-18">                 <span class="at" style="color: #657422;">gamma_t =</span> <span class="fu" style="color: #4758AB;">arima.sim</span>(<span class="at" style="color: #657422;">n=</span>T, <span class="fu" style="color: #4758AB;">list</span>(<span class="at" style="color: #657422;">ar =</span> rho_t, <span class="at" style="color: #657422;">order=</span><span class="fu" style="color: #4758AB;">c</span>(<span class="dv" style="color: #AD0000;">1</span>,<span class="dv" style="color: #AD0000;">0</span>,<span class="dv" style="color: #AD0000;">0</span>))) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">as.vector</span>())</span>
<span id="cb6-19"></span>
<span id="cb6-20">    <span class="co" style="color: #5E5E5E;"># Individual measures and effects</span></span>
<span id="cb6-21">    i_ <span class="ot" style="color: #003B4F;">&lt;-</span></span>
<span id="cb6-22">      <span class="fu" style="color: #4758AB;">data.frame</span>(</span>
<span id="cb6-23">        <span class="at" style="color: #657422;">unit_id =</span> <span class="dv" style="color: #AD0000;">1</span><span class="sc" style="color: #5E5E5E;">:</span>N,</span>
<span id="cb6-24">        <span class="at" style="color: #657422;">x_i =</span> <span class="fu" style="color: #4758AB;">rnorm</span>(N, <span class="at" style="color: #657422;">mean =</span> <span class="dv" style="color: #AD0000;">0</span>, <span class="at" style="color: #657422;">sd =</span> <span class="dv" style="color: #AD0000;">1</span>),</span>
<span id="cb6-25">        <span class="at" style="color: #657422;">u_i =</span> <span class="fu" style="color: #4758AB;">rnorm</span>(N, <span class="at" style="color: #657422;">mean =</span> <span class="dv" style="color: #AD0000;">0</span>, <span class="at" style="color: #657422;">sd =</span> <span class="dv" style="color: #AD0000;">1</span>)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb6-26">      <span class="fu" style="color: #4758AB;">rowwise</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="co" style="color: #5E5E5E;"># This allows us to get each value's pr_treated in the line below. </span></span>
<span id="cb6-27">      <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">pr_treated =</span> boot<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">inv.logit</span>(u_i)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-28">      <span class="fu" style="color: #4758AB;">ungroup</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span>  <span class="co" style="color: #5E5E5E;"># This undoes the rowwise </span></span>
<span id="cb6-29">      <span class="co" style="color: #5E5E5E;"># Treatment indicator</span></span>
<span id="cb6-30">      <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">d_i =</span> <span class="fu" style="color: #4758AB;">rbinom</span>(N, <span class="at" style="color: #657422;">size =</span> <span class="dv" style="color: #AD0000;">1</span>, <span class="at" style="color: #657422;">prob =</span> pr_treated)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-31">      <span class="fu" style="color: #4758AB;">ungroup</span>()</span>
<span id="cb6-32"></span>
<span id="cb6-33">    <span class="fu" style="color: #4758AB;">crossing</span>(<span class="at" style="color: #657422;">unit_id =</span> i_<span class="sc" style="color: #5E5E5E;">$</span>unit_id,<span class="at" style="color: #657422;">t =</span> t_<span class="sc" style="color: #5E5E5E;">$</span>t) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb6-34">      <span class="fu" style="color: #4758AB;">left_join</span>(i_,<span class="st" style="color: #20794D;">"unit_id"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb6-35">      <span class="fu" style="color: #4758AB;">left_join</span>(t_,<span class="st" style="color: #20794D;">"t"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb6-36">      <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">d_i =</span> <span class="fu" style="color: #4758AB;">ifelse</span>(t<span class="sc" style="color: #5E5E5E;">&lt;</span>tx_time,<span class="dv" style="color: #AD0000;">0</span>,d_i)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb6-37">      <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">y_i =</span> beta_0 <span class="sc" style="color: #5E5E5E;">+</span> beta_1 <span class="sc" style="color: #5E5E5E;">*</span> x_i <span class="sc" style="color: #5E5E5E;">+</span> tau <span class="sc" style="color: #5E5E5E;">*</span> d_i <span class="sc" style="color: #5E5E5E;">+</span> u_i <span class="sc" style="color: #5E5E5E;">+</span> gamma_t <span class="sc" style="color: #5E5E5E;">+</span> <span class="fu" style="color: #4758AB;">rnorm</span>(N, <span class="at" style="color: #657422;">mean =</span> <span class="dv" style="color: #AD0000;">0</span>, <span class="at" style="color: #657422;">sd =</span> <span class="dv" style="color: #AD0000;">1</span>)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-38">      <span class="fu" style="color: #4758AB;">select</span>(unit_id, t, y_i , x_i, d_i)</span>
<span id="cb6-39">  })</span>
<span id="cb6-40">}</span>
<span id="cb6-41"></span>
<span id="cb6-42">estimator_fn_re <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="cf" style="color: #003B4F;">function</span>(df) {</span>
<span id="cb6-43">  <span class="fu" style="color: #4758AB;">lmer</span>(y_i <span class="sc" style="color: #5E5E5E;">~</span>  d_i <span class="sc" style="color: #5E5E5E;">+</span> (<span class="dv" style="color: #AD0000;">1</span><span class="sc" style="color: #5E5E5E;">|</span>unit_id) , df)</span>
<span id="cb6-44">}</span>
<span id="cb6-45"></span>
<span id="cb6-46">disc_fn_re <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="cf" style="color: #003B4F;">function</span>(fit) {</span>
<span id="cb6-47">  fit <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">summary</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">pluck</span>(<span class="st" style="color: #20794D;">"coefficients"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb6-48">    <span class="fu" style="color: #4758AB;">data.frame</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb6-49">    <span class="fu" style="color: #4758AB;">rownames_to_column</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb6-50">    janitor<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">clean_names</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb6-51">    <span class="fu" style="color: #4758AB;">filter</span>(rowname<span class="sc" style="color: #5E5E5E;">==</span><span class="st" style="color: #20794D;">"d_i"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb6-52">    <span class="fu" style="color: #4758AB;">pull</span>(estimate) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb6-53">    <span class="fu" style="color: #4758AB;">as.vector</span>()</span>
<span id="cb6-54">}</span>
<span id="cb6-55"></span>
<span id="cb6-56">generate_estimate_discriminate_re <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="cf" style="color: #003B4F;">function</span>(params) {</span>
<span id="cb6-57">  params <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="co" style="color: #5E5E5E;"># Step 1: Parameterize the problem</span></span>
<span id="cb6-58">      <span class="fu" style="color: #4758AB;">dgp_panel</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span>  <span class="co" style="color: #5E5E5E;"># Step 2: Define the data generation process</span></span>
<span id="cb6-59">        <span class="fu" style="color: #4758AB;">estimator_fn_re</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span>  <span class="co" style="color: #5E5E5E;"># Step 3: Estimate </span></span>
<span id="cb6-60">          <span class="fu" style="color: #4758AB;">disc_fn_re</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="co" style="color: #5E5E5E;"># Step 4: Pull out what you need</span></span>
<span id="cb6-61">            <span class="fu" style="color: #4758AB;">data.frame</span>(<span class="at" style="color: #657422;">tau_hat =</span> .) <span class="co" style="color: #5E5E5E;"># store the result as a data frame object</span></span>
<span id="cb6-62">}</span>
<span id="cb6-63"></span>
<span id="cb6-64">construct_dm <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="cf" style="color: #003B4F;">function</span>(df) {</span>
<span id="cb6-65">  df_ <span class="ot" style="color: #003B4F;">&lt;-</span> </span>
<span id="cb6-66">    df <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-67">      <span class="co" style="color: #5E5E5E;"># mutate(y_i = y_i + mean(y_i),</span></span>
<span id="cb6-68">      <span class="co" style="color: #5E5E5E;">#       d_i = d_i + mean(d_i)) %&gt;% </span></span>
<span id="cb6-69">      <span class="co" style="color: #5E5E5E;">#       group_by(t) %&gt;% </span></span>
<span id="cb6-70">      <span class="co" style="color: #5E5E5E;">#       mutate(y_i = y_i - mean(y_i),</span></span>
<span id="cb6-71">      <span class="co" style="color: #5E5E5E;">#       d_i = d_i - mean(d_i)) %&gt;% </span></span>
<span id="cb6-72">            <span class="fu" style="color: #4758AB;">group_by</span>(unit_id) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-73">            <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">y_i =</span> y_i <span class="sc" style="color: #5E5E5E;">-</span> <span class="fu" style="color: #4758AB;">mean</span>(y_i),</span>
<span id="cb6-74">            <span class="at" style="color: #657422;">d_i =</span> d_i <span class="sc" style="color: #5E5E5E;">-</span> <span class="fu" style="color: #4758AB;">mean</span>(d_i))</span>
<span id="cb6-75"></span>
<span id="cb6-76">  <span class="fu" style="color: #4758AB;">return</span>(df_)</span>
<span id="cb6-77">}</span>
<span id="cb6-78"></span>
<span id="cb6-79">estimate_dm <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="cf" style="color: #003B4F;">function</span>(df) {</span>
<span id="cb6-80">  <span class="fu" style="color: #4758AB;">lm</span>(y_i <span class="sc" style="color: #5E5E5E;">~</span> d_i   , <span class="at" style="color: #657422;">data =</span> df)</span>
<span id="cb6-81">}</span>
<span id="cb6-82"></span>
<span id="cb6-83">disc_fn_dm <span class="ot" style="color: #003B4F;">=</span> <span class="cf" style="color: #003B4F;">function</span>(fit) {</span>
<span id="cb6-84">  fit_ <span class="ot" style="color: #003B4F;">=</span>broom<span class="sc" style="color: #5E5E5E;">::</span><span class="fu" style="color: #4758AB;">tidy</span>(fit)   <span class="co" style="color: #5E5E5E;"># This cleans up the fitted regression object</span></span>
<span id="cb6-85">  out <span class="ot" style="color: #003B4F;">=</span>fit_ <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-86">    <span class="fu" style="color: #4758AB;">filter</span>(term<span class="sc" style="color: #5E5E5E;">==</span><span class="st" style="color: #20794D;">"d_i"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-87">    <span class="fu" style="color: #4758AB;">pull</span>(estimate)</span>
<span id="cb6-88">  </span>
<span id="cb6-89">  <span class="fu" style="color: #4758AB;">return</span>(out)</span>
<span id="cb6-90">}</span>
<span id="cb6-91"></span>
<span id="cb6-92"></span>
<span id="cb6-93"><span class="fu" style="color: #4758AB;">set.seed</span>(<span class="dv" style="color: #AD0000;">123</span>)</span>
<span id="cb6-94">df_c <span class="ot" style="color: #003B4F;">&lt;-</span> </span>
<span id="cb6-95">  <span class="fu" style="color: #4758AB;">modifyList</span>(params_panel,<span class="fu" style="color: #4758AB;">list</span>(<span class="at" style="color: #657422;">T=</span><span class="dv" style="color: #AD0000;">400</span>,<span class="at" style="color: #657422;">tx_time=</span><span class="dv" style="color: #AD0000;">200</span>)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-96">  <span class="fu" style="color: #4758AB;">dgp_panel</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-97">  <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">index =</span> t<span class="dv" style="color: #AD0000;">-200</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-98">  <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">T2=</span> <span class="fu" style="color: #4758AB;">as.integer</span>(index <span class="sc" style="color: #5E5E5E;">%in%</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="sc" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">1</span>,<span class="dv" style="color: #AD0000;">0</span>))) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-99">  <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">T4 =</span> <span class="fu" style="color: #4758AB;">as.integer</span>(index <span class="sc" style="color: #5E5E5E;">&gt;</span> <span class="sc" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">3</span> <span class="sc" style="color: #5E5E5E;">&amp;</span> index <span class="sc" style="color: #5E5E5E;">&lt;</span><span class="dv" style="color: #AD0000;">2</span>)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb6-100">  <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">T10 =</span> <span class="fu" style="color: #4758AB;">as.integer</span>(index <span class="sc" style="color: #5E5E5E;">&gt;=</span> <span class="sc" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">5</span> <span class="sc" style="color: #5E5E5E;">&amp;</span> index<span class="sc" style="color: #5E5E5E;">&lt;</span><span class="dv" style="color: #AD0000;">5</span>)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-101">  <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">T20 =</span> <span class="fu" style="color: #4758AB;">as.integer</span>(index <span class="sc" style="color: #5E5E5E;">&gt;=</span> <span class="sc" style="color: #5E5E5E;">-</span><span class="dv" style="color: #AD0000;">10</span> <span class="sc" style="color: #5E5E5E;">&amp;</span> index <span class="sc" style="color: #5E5E5E;">&lt;</span><span class="dv" style="color: #AD0000;">10</span> )) <span class="sc" style="color: #5E5E5E;">%&gt;%</span></span>
<span id="cb6-102">  <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">T50 =</span> <span class="dv" style="color: #AD0000;">1</span> ) </span>
<span id="cb6-103"></span>
<span id="cb6-104">df <span class="ot" style="color: #003B4F;">&lt;-</span> df_c <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">filter</span>(T4<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1</span>)</span>
<span id="cb6-105"></span>
<span id="cb6-106">params_panel <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-107">  <span class="fu" style="color: #4758AB;">dgp_panel</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-108">  <span class="fu" style="color: #4758AB;">head</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb6-109">  <span class="fu" style="color: #4758AB;">kable</span>(<span class="at" style="color: #657422;">digits=</span><span class="dv" style="color: #AD0000;">3</span>)</span></code></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: right;">unit_id</th>
<th style="text-align: right;">t</th>
<th style="text-align: right;">y_i</th>
<th style="text-align: right;">x_i</th>
<th style="text-align: right;">d_i</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2.855</td>
<td style="text-align: right;">0.502</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">1</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">2.825</td>
<td style="text-align: right;">0.502</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: right;">2</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">5.893</td>
<td style="text-align: right;">1.434</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">7.620</td>
<td style="text-align: right;">1.434</td>
<td style="text-align: right;">1</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">3.225</td>
<td style="text-align: right;">2.166</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: right;">3</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">6.555</td>
<td style="text-align: right;">2.166</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Let’s first show the equivalance between the random effect model and a quasi-demeaned linear regression model. We’ll do so by focusing on a case where <img src="https://latex.codecogs.com/png.latex?T=4">.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1">fit_re <span class="ot" style="color: #003B4F;">&lt;-</span> </span>
<span id="cb7-2">  df <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb7-3">  <span class="fu" style="color: #4758AB;">estimator_fn_re</span>()</span>
<span id="cb7-4"></span>
<span id="cb7-5"><span class="fu" style="color: #4758AB;">summary</span>(fit_re)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Linear mixed model fit by REML ['lmerMod']
Formula: y_i ~ d_i + (1 | unit_id)
   Data: df

REML criterion at convergence: 14733.6

Scaled residuals: 
    Min      1Q  Median      3Q     Max 
-2.0705 -0.7249  0.1037  0.6245  2.0637 

Random effects:
 Groups   Name        Variance Std.Dev.
 unit_id  (Intercept) 5.462    2.337   
 Residual             1.085    1.041   
Number of obs: 4000, groups:  unit_id, 1000

Fixed effects:
            Estimate Std. Error t value
(Intercept)  0.29151    0.07661   3.805
d_i         -0.51889    0.04550 -11.403

Correlation of Fixed Effects:
    (Intr)
d_i -0.152</code></pre>
</div>
</div>
<ul>
<li>Notice the use of the term “fixed effects” is based on a traditional statistical definition–these are the regression parameters not assumed to come from a stochastic (statsitical) distribution, such as the random effects.</li>
</ul>
<p>Let’s now extract out the variance parameter estimates <img src="https://latex.codecogs.com/png.latex?%5Csigma%5E2_%7B%5Cepsilon%7D"> and <img src="https://latex.codecogs.com/png.latex?%5Csigma%5E2_u">:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1">get_re <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="cf" style="color: #003B4F;">function</span>(fit) {</span>
<span id="cb9-2">    x <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">VarCorr</span>(fit) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">data.frame</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb9-3">    <span class="fu" style="color: #4758AB;">tibble</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb9-4">    <span class="fu" style="color: #4758AB;">select</span>(grp,var1,vcov)</span>
<span id="cb9-5">}</span>
<span id="cb9-6"></span>
<span id="cb9-7">re_est <span class="ot" style="color: #003B4F;">&lt;-</span> </span>
<span id="cb9-8">  fit_re <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb9-9">  <span class="fu" style="color: #4758AB;">get_re</span>()</span></code></pre></div>
</div>
<div class="cell">
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">grp</th>
<th style="text-align: left;">var1</th>
<th style="text-align: right;">vcov</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">unit_id</td>
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">5.462082</td>
</tr>
<tr class="even">
<td style="text-align: left;">Residual</td>
<td style="text-align: left;">NA</td>
<td style="text-align: right;">1.084670</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We can then use these to calculatate <img src="https://latex.codecogs.com/png.latex?%5Ctheta">:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1">sigma2_e <span class="ot" style="color: #003B4F;">=</span> fit_re <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">get_re</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">filter</span>(grp<span class="sc" style="color: #5E5E5E;">==</span><span class="st" style="color: #20794D;">"Residual"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">pull</span>(vcov)</span>
<span id="cb10-2">sigma2_ui <span class="ot" style="color: #003B4F;">=</span> fit_re <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">get_re</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">filter</span>(grp<span class="sc" style="color: #5E5E5E;">==</span><span class="st" style="color: #20794D;">"unit_id"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">pull</span>(vcov)</span>
<span id="cb10-3">theta_i <span class="ot" style="color: #003B4F;">=</span> <span class="dv" style="color: #AD0000;">1</span> <span class="sc" style="color: #5E5E5E;">-</span> <span class="fu" style="color: #4758AB;">sqrt</span>(sigma2_e<span class="sc" style="color: #5E5E5E;">/</span>(<span class="dv" style="color: #AD0000;">4</span><span class="sc" style="color: #5E5E5E;">*</span>sigma2_ui <span class="sc" style="color: #5E5E5E;">+</span> sigma2_e))</span>
<span id="cb10-4"></span>
<span id="cb10-5">theta_i</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7825205</code></pre>
</div>
</div>
<p>Next we will create a quasi-demeaned version of our input data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1">df_ <span class="ot" style="color: #003B4F;">&lt;-</span> </span>
<span id="cb12-2">  df <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb12-3">  <span class="fu" style="color: #4758AB;">group_by</span>(unit_id) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb12-4">  <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">y_i =</span> y_i <span class="sc" style="color: #5E5E5E;">-</span> theta_i <span class="sc" style="color: #5E5E5E;">*</span> <span class="fu" style="color: #4758AB;">mean</span>(y_i),</span>
<span id="cb12-5">         <span class="at" style="color: #657422;">d_i =</span> d_i <span class="sc" style="color: #5E5E5E;">-</span> theta_i <span class="sc" style="color: #5E5E5E;">*</span> <span class="fu" style="color: #4758AB;">mean</span>(d_i))</span></code></pre></div>
</div>
<p>We now fit a quasi-demeaned</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1">fit_qdm <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">lm</span>(y_i <span class="sc" style="color: #5E5E5E;">~</span> d_i, <span class="at" style="color: #657422;">data =</span> df_)</span>
<span id="cb13-2"><span class="fu" style="color: #4758AB;">summary</span>(fit_qdm)</span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = y_i ~ d_i, data = df_)

Residuals:
    Min      1Q  Median      3Q     Max 
-3.1586 -0.7768  0.0980  0.7425  3.2119 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  0.06340    0.01666   3.805 0.000144 ***
d_i         -0.51889    0.04550 -11.403  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 1.041 on 3998 degrees of freedom
Multiple R-squared:  0.0315,    Adjusted R-squared:  0.03126 
F-statistic:   130 on 1 and 3998 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>Now let’s compare:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1">res <span class="ot" style="color: #003B4F;">&lt;-</span> </span>
<span id="cb15-2">  fit_qdm <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">tidy</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb15-3">  <span class="fu" style="color: #4758AB;">select</span>(term,<span class="at" style="color: #657422;">estimate_qdm =</span> estimate) </span>
<span id="cb15-4"></span>
<span id="cb15-5"><span class="fu" style="color: #4758AB;">cbind</span>(res,df <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">estimator_fn_re</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">summary</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">pluck</span>(<span class="st" style="color: #20794D;">"coefficients"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb15-6">  <span class="fu" style="color: #4758AB;">data.frame</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb15-7">  <span class="fu" style="color: #4758AB;">select</span>(<span class="at" style="color: #657422;">estimate_re =</span> Estimate)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb15-8">  <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">theta =</span> theta_i) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb15-9">  <span class="fu" style="color: #4758AB;">select</span>(term, estimate_re, estimate_qdm, theta) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb15-10">  <span class="fu" style="color: #4758AB;">remove_rownames</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb15-11">  <span class="fu" style="color: #4758AB;">kable</span>(<span class="at" style="color: #657422;">digits =</span> <span class="dv" style="color: #AD0000;">3</span>)</span></code></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">term</th>
<th style="text-align: right;">estimate_re</th>
<th style="text-align: right;">estimate_qdm</th>
<th style="text-align: right;">theta</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">0.292</td>
<td style="text-align: right;">0.063</td>
<td style="text-align: right;">0.783</td>
</tr>
<tr class="even">
<td style="text-align: left;">d_i</td>
<td style="text-align: right;">-0.519</td>
<td style="text-align: right;">-0.519</td>
<td style="text-align: right;">0.783</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1">get_theta <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="cf" style="color: #003B4F;">function</span>(fit) {</span>
<span id="cb16-2">  sigma2_e <span class="ot" style="color: #003B4F;">=</span> fit <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">get_re</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">filter</span>(grp<span class="sc" style="color: #5E5E5E;">==</span><span class="st" style="color: #20794D;">"Residual"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">pull</span>(vcov)</span>
<span id="cb16-3">  sigma2_ui <span class="ot" style="color: #003B4F;">=</span> fit <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">get_re</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">filter</span>(grp<span class="sc" style="color: #5E5E5E;">==</span><span class="st" style="color: #20794D;">"unit_id"</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">pull</span>(vcov)</span>
<span id="cb16-4">  theta <span class="ot" style="color: #003B4F;">=</span> <span class="dv" style="color: #AD0000;">1</span> <span class="sc" style="color: #5E5E5E;">-</span> <span class="fu" style="color: #4758AB;">sqrt</span>(sigma2_e<span class="sc" style="color: #5E5E5E;">/</span>(<span class="dv" style="color: #AD0000;">4</span><span class="sc" style="color: #5E5E5E;">*</span>sigma2_ui <span class="sc" style="color: #5E5E5E;">+</span> sigma2_e))</span>
<span id="cb16-5">  theta </span>
<span id="cb16-6">}</span>
<span id="cb16-7"></span>
<span id="cb16-8">t_qdm <span class="ot" style="color: #003B4F;">&lt;-</span> <span class="fu" style="color: #4758AB;">tibble</span>(</span>
<span id="cb16-9">  <span class="at" style="color: #657422;">T2 =</span> df_c <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">filter</span>(T2<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">estimator_fn_re</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">disc_fn_re</span>(),</span>
<span id="cb16-10">  <span class="at" style="color: #657422;">theta2  =</span> df_c <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">filter</span>(T2<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">estimator_fn_re</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">get_theta</span>(),</span>
<span id="cb16-11">  <span class="at" style="color: #657422;">T2fe =</span> df_c <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">filter</span>(T2<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">construct_dm</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">estimate_dm</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">disc_fn_dm</span>()  ,</span>
<span id="cb16-12">  <span class="at" style="color: #657422;">T4 =</span> df_c <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">filter</span>(T4<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">estimator_fn_re</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">disc_fn_re</span>(),</span>
<span id="cb16-13">  <span class="at" style="color: #657422;">theta4  =</span> df_c <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">filter</span>(T4<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">estimator_fn_re</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">get_theta</span>(),</span>
<span id="cb16-14">  <span class="at" style="color: #657422;">T4fe =</span> df_c <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">filter</span>(T4<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">construct_dm</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">estimate_dm</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">disc_fn_dm</span>()    ,</span>
<span id="cb16-15">  <span class="at" style="color: #657422;">T10 =</span> df_c <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">filter</span>(T10<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">estimator_fn_re</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">disc_fn_re</span>(),</span>
<span id="cb16-16">  <span class="at" style="color: #657422;">theta10  =</span> df_c <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">filter</span>(T10<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">estimator_fn_re</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">get_theta</span>(),  </span>
<span id="cb16-17">  <span class="at" style="color: #657422;">T10fe =</span> df_c <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">filter</span>(T10<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">construct_dm</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">estimate_dm</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">disc_fn_dm</span>()   ,</span>
<span id="cb16-18">  <span class="at" style="color: #657422;">T20 =</span> df_c <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">filter</span>(T20<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">estimator_fn_re</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">disc_fn_re</span>(),</span>
<span id="cb16-19">  <span class="at" style="color: #657422;">theta20  =</span> df_c <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">filter</span>(T20<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">estimator_fn_re</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">get_theta</span>(),  </span>
<span id="cb16-20">  <span class="at" style="color: #657422;">T20fe =</span> df_c <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">filter</span>(T20<span class="sc" style="color: #5E5E5E;">==</span><span class="dv" style="color: #AD0000;">1</span>) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">construct_dm</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">estimate_dm</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">disc_fn_dm</span>()  ,</span>
<span id="cb16-21">  <span class="at" style="color: #657422;">T400 =</span> df_c <span class="sc" style="color: #5E5E5E;">%&gt;%</span>  <span class="fu" style="color: #4758AB;">estimator_fn_re</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">disc_fn_re</span>(),</span>
<span id="cb16-22">  <span class="at" style="color: #657422;">theta400 =</span>  df_c <span class="sc" style="color: #5E5E5E;">%&gt;%</span>  <span class="fu" style="color: #4758AB;">estimator_fn_re</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">get_theta</span>(),</span>
<span id="cb16-23">  <span class="at" style="color: #657422;">T400fe =</span> df_c <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">construct_dm</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">estimate_dm</span>() <span class="sc" style="color: #5E5E5E;">%&gt;%</span> <span class="fu" style="color: #4758AB;">disc_fn_dm</span>()</span>
<span id="cb16-24">)</span>
<span id="cb16-25">  </span>
<span id="cb16-26">t_qdm <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb16-27">  <span class="fu" style="color: #4758AB;">select</span>(<span class="sc" style="color: #5E5E5E;">-</span><span class="fu" style="color: #4758AB;">starts_with</span>(<span class="st" style="color: #20794D;">"theta"</span>)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb16-28">  <span class="fu" style="color: #4758AB;">gather</span>(measure,value) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb16-29">  <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">method =</span> <span class="fu" style="color: #4758AB;">ifelse</span>(<span class="fu" style="color: #4758AB;">grepl</span>(<span class="st" style="color: #20794D;">"fe"</span>,measure),<span class="st" style="color: #20794D;">"FE"</span>,<span class="st" style="color: #20794D;">"RE"</span>)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb16-30">  <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">measure =</span> <span class="fu" style="color: #4758AB;">gsub</span>(<span class="st" style="color: #20794D;">"fe"</span>,<span class="st" style="color: #20794D;">""</span>,measure)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb16-31">  <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">measure =</span> <span class="fu" style="color: #4758AB;">case_when</span>(measure <span class="sc" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"T2"</span> <span class="sc" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"T = 2"</span>,</span>
<span id="cb16-32">                             measure <span class="sc" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"T4"</span> <span class="sc" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"T = 4"</span>,</span>
<span id="cb16-33">                             measure <span class="sc" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"T10"</span> <span class="sc" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"T = 10"</span>,</span>
<span id="cb16-34">                             measure <span class="sc" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"T20"</span> <span class="sc" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"T = 20"</span>,</span>
<span id="cb16-35">                             measure <span class="sc" style="color: #5E5E5E;">==</span> <span class="st" style="color: #20794D;">"T400"</span> <span class="sc" style="color: #5E5E5E;">~</span> <span class="st" style="color: #20794D;">"T = 400"</span>)) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb16-36">  <span class="fu" style="color: #4758AB;">rename</span>(<span class="at" style="color: #657422;">time_periods =</span> measure) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb16-37">  <span class="fu" style="color: #4758AB;">spread</span>(method, value) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb16-38">  <span class="fu" style="color: #4758AB;">mutate</span>(<span class="at" style="color: #657422;">time_periods =</span> <span class="fu" style="color: #4758AB;">factor</span>(time_periods, <span class="at" style="color: #657422;">levels =</span> <span class="fu" style="color: #4758AB;">c</span>(<span class="st" style="color: #20794D;">"T = 2"</span>,<span class="st" style="color: #20794D;">"T = 4"</span>, <span class="st" style="color: #20794D;">"T = 10"</span>,<span class="st" style="color: #20794D;">"T = 20"</span> , <span class="st" style="color: #20794D;">"T = 400"</span>))) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb16-39">  <span class="fu" style="color: #4758AB;">arrange</span>(time_periods) <span class="sc" style="color: #5E5E5E;">%&gt;%</span> </span>
<span id="cb16-40">  <span class="fu" style="color: #4758AB;">kable</span>()</span></code></pre></div>
</details>
</div>


</section>

 ]]></description>
  <guid>https://graveja0.github.io/HPOL8539-F2022/blog/posts/quasi-demeaning.html</guid>
  <pubDate>Wed, 09 Nov 2022 11:57:11 GMT</pubDate>
</item>
</channel>
</rss>
